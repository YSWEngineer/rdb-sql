# 第5章 式と関数
SQLでできることは、単なるデータの出し入れだけではありません。式を用いることで、列の値やリテラルを使った四則演算を行うことができます。

また、渡された情報に基づき、あらかじめ準備されたさまざまな種類の処理を行ってくれる関数という仕組みもあります。

この章では、指揮や関数を用いてデータの計算や変換をするさまざまな方法について紹介します。

<details><summary>5.1 式と演算子</summary>

### 5.1.1 式の種類
第3章で「WHERE句には条件式を記述すること」を学びました。たとえば、WHEREに続けて記述する「**出金額 > 0**」のようなものが条件式であり、その結果は必ず真か偽になりました。

一方、「出金額 + 100」のような、結果が真や偽にならない式を本書では計算式と呼ぶことにします。計算式も、評価されると結果に「化ける」点では条件式と同じです。

最終的に具体的な値に化ける計算式は、「**出金額 + 50 > 100**」のように、条件式の一部として用いられることもあります。ほかにもSQL文の中のさまざまな場所で、値の代わりに自由に記述することができます。

### 5.1.2 選択列リストで計算式を使う
SELECT分において、SELECTのすぐ後ろに指定するのが選択列リストです。選択列リストは、結果表にどのような列を出力するかを指定する役割があります。列名のほかにも固定値や計算式を指定することも可能です。

- リスト5-1 選択列リストへのさまざまな指定

```sql
SELECT 出金額,               -- 列名での指定
       出金額 + 100,         -- 計算式での指定
       'SQL'                -- 固定値での指定
  FROM 家計簿
```

| 出金額 | 出金額 + 100 | ‘SQL’ |
| --- | --- | --- |
| 380 | 480 | SQL |
| 0 | 100 | SQL |
| 2800 | 2900 | SQL |
| 5000 | 5100 | SQL |
| 7560 | 7660 | SQL |

- 選択列リストへの指定と結果
    - 列名：列の内容がそのまま出力される
    - 計算式：計算式の評価結果が出力される
    - 固定値：固定値がそのまま出力される

選択列リストに計算式や固定値を使うと、その計算式などがそのまま結果表の列名になってしまいます。その場合は、第2章で紹介した列の別名(p055)を使うことで解決できます。

- リスト5-2 計算式に別名をつける

```sql
SELECT 出金額,
       出金額 + 100 AS 100円増しの出金額 # 列の別名を命名できる
  FROM 家計簿
```

**※選択列リストで計算式を使う場合は、必ずASを併用するようにするとわかりやすくて良い。**

### 5.1.3 データの代わりに計算式を使う
INSERTやUPDATEで具体的な値の代わりに式を指定する方法です。
- リスト5-3 INSERT文での計算式の利用

```sql
INSERT INTO 家計簿 (出金額)
     VALUES (1000 + 105) # 「1000 + 105」という計算式を指定している
# 直接「1105」を指定した場合と同じ結果になる
```

- リスト5-4 UPDATE文での計算式の利用(列を含む)

```sql
UPDATE 家計簿
   SET 出金額 = 出金額 + 100 # 現在の出金額を100円増加させる
```

### 5.1.4 式が評価される仕組み
- **混乱しやすい列指定の捉え方**
    - 式中の「出金額」とは、テーブル内の出金額の列を指している。
    - 出金額の列には、複数の値(0,7560,5000…)が入っている。
    - よって、「出金額 + 100」は、複数の値と100の足し算になる。
    - 複数の値と100を足すことなんてできないのでは？
    
    このように混乱しないために、次の原則をしっかり理解する必要があります。
    
- **DBMSによる処理の原則**
    
    DBMSは、テーブル内の各業を1つずつ順番に処理していく。式の評価なども、各行ごとに行われる。
    

たとえば、リスト5-4のUPDATE文も「1回の処理で出金額列がすべて書き換わる」と捉えるべきではありません。DBMSは、「1行に注目しては、出金額を計算して更新する」という処理を、行数分繰り返しているのです。

**※ある列の内容を一気に書き換えられるのではなく、1行ずつその列の値を計算している。**

つまり、DBMSが式を評価するときには、常にいずれか1行にだけ注目しているのです。今回の場合だと、DBMSは「注目している行の出金額 + 100」を何度も計算しているだけなのです。

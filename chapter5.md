# 第5章 式と関数
SQLでできることは、単なるデータの出し入れだけではありません。式を用いることで、列の値やリテラルを使った四則演算を行うことができます。

また、渡された情報に基づき、あらかじめ準備されたさまざまな種類の処理を行ってくれる関数という仕組みもあります。

この章では、指揮や関数を用いてデータの計算や変換をするさまざまな方法について紹介します。

<details><summary>5.1 式と演算子</summary>

### 5.1.1 式の種類
第3章で「WHERE句には条件式を記述すること」を学びました。たとえば、WHEREに続けて記述する「**出金額 > 0**」のようなものが条件式であり、その結果は必ず真か偽になりました。

一方、「出金額 + 100」のような、結果が真や偽にならない式を本書では計算式と呼ぶことにします。計算式も、評価されると結果に「化ける」点では条件式と同じです。

最終的に具体的な値に化ける計算式は、「**出金額 + 50 > 100**」のように、条件式の一部として用いられることもあります。ほかにもSQL文の中のさまざまな場所で、値の代わりに自由に記述することができます。

### 5.1.2 選択列リストで計算式を使う
SELECT分において、SELECTのすぐ後ろに指定するのが選択列リストです。選択列リストは、結果表にどのような列を出力するかを指定する役割があります。列名のほかにも固定値や計算式を指定することも可能です。

- リスト5-1 選択列リストへのさまざまな指定

```sql
SELECT 出金額,               -- 列名での指定
       出金額 + 100,         -- 計算式での指定
       'SQL'                -- 固定値での指定
  FROM 家計簿
```

| 出金額 | 出金額 + 100 | ‘SQL’ |
| --- | --- | --- |
| 380 | 480 | SQL |
| 0 | 100 | SQL |
| 2800 | 2900 | SQL |
| 5000 | 5100 | SQL |
| 7560 | 7660 | SQL |

- 選択列リストへの指定と結果
    - 列名：列の内容がそのまま出力される
    - 計算式：計算式の評価結果が出力される
    - 固定値：固定値がそのまま出力される

選択列リストに計算式や固定値を使うと、その計算式などがそのまま結果表の列名になってしまいます。その場合は、第2章で紹介した列の別名(p055)を使うことで解決できます。

- リスト5-2 計算式に別名をつける

```sql
SELECT 出金額,
       出金額 + 100 AS 100円増しの出金額 # 列の別名を命名できる
  FROM 家計簿
```

**※選択列リストで計算式を使う場合は、必ずASを併用するようにするとわかりやすくて良い。**

### 5.1.3 データの代わりに計算式を使う
INSERTやUPDATEで具体的な値の代わりに式を指定する方法です。
- リスト5-3 INSERT文での計算式の利用

```sql
INSERT INTO 家計簿 (出金額)
     VALUES (1000 + 105) # 「1000 + 105」という計算式を指定している
# 直接「1105」を指定した場合と同じ結果になる
```

- リスト5-4 UPDATE文での計算式の利用(列を含む)

```sql
UPDATE 家計簿
   SET 出金額 = 出金額 + 100 # 現在の出金額を100円増加させる
```

### 5.1.4 式が評価される仕組み
- **混乱しやすい列指定の捉え方**
    - 式中の「出金額」とは、テーブル内の出金額の列を指している。
    - 出金額の列には、複数の値(0,7560,5000…)が入っている。
    - よって、「出金額 + 100」は、複数の値と100の足し算になる。
    - 複数の値と100を足すことなんてできないのでは？
    
    このように混乱しないために、次の原則をしっかり理解する必要があります。
    
- **DBMSによる処理の原則**
    
    DBMSは、テーブル内の各業を1つずつ順番に処理していく。式の評価なども、各行ごとに行われる。
    

たとえば、リスト5-4のUPDATE文も「1回の処理で出金額列がすべて書き換わる」と捉えるべきではありません。DBMSは、「1行に注目しては、出金額を計算して更新する」という処理を、行数分繰り返しているのです。

**※ある列の内容を一気に書き換えられるのではなく、1行ずつその列の値を計算している。**

つまり、DBMSが式を評価するときには、常にいずれか1行にだけ注目しているのです。今回の場合だと、DBMSは「注目している行の出金額 + 100」を何度も計算しているだけなのです。</details>


<details><summary>5.2 さまざまな演算子</summary>

### 5.2.1 基本的な算術演算子
「+」以外にも、SQLにはさまざまな演算子が用意されています。代表的なものをまとめました。
- 代表的な演算子

| 演算子 | 使い方 | 説明 |
| --- | --- | --- |
| + | 数値 + 数値 | 数値同士で足し算をする |
| + | 日付 + 数値 | 日付を指定日数だけ進める |
| - | 数値 - 数値 | 数値同士で引き算をする |
| - | 日付 - 数値 | 日付を指定日数だけ戻す |
| - | 日付 - 日付 | 日付の差の日数を得る |
| * | 数値 * 数値 | 数値同士で掛け算をする |
| / | 数値 / 数値 | 数値同士で割り算をする ※1 |
| || | 文字列 || 文字列 | 文字列を連結する ※2 |

※1：整数同士の場合は商が返される。

※2：DBMSによっては文字列連結の演算子として「||」ではなく「＋」が利用されることもある。

+演算子や-演算子は、数値の計算以外にも利用できます。日付の計算や、DBMSによっては文字列の連結ができることはぜひ覚えておきましょう。

### 5.2.2 CASE演算子 — 値を変換する
CASE演算子は、列の値や条件式を評価し、その結果に応じて好きな値に変換することができます。使い方は2通りあります。
- **CASE演算子の利用構文(1)**
    
    ```sql
    CASE 評価する列や式 WHEN 値1 THEN 値1のときに返す値
                     (WHEN 値2 THEN 値2のときに返す値)...
                     (ELSE デフォルト値)
     END
    ```
    
    リスト5-5では、CASEからENDまでの部分が1つの選択列であり、条件に応じた結果に化けることに注目してください。
    
    - リスト5-5 CASE演算子を使ったSELECT文(1)
    
    ```sql
    /* 費目の値に応じて変換する */
    SELECT 費目, 出金額,
           CASE 費目 WHEN '居住費' THEN '固定費'
                    WHEN '水道光熱費' THEN '固定費'
                    ELSE '変動費'
           END AS 出費の分類
      FROM 家計簿 WHERE 出金額 > 0
    ```
    
    | 費目 | 出金額 | 出費の分類 |
    | --- | --- | --- |
    | 食費 | 380 | 変動費 |
    | 教養娯楽費 | 2800 | 変動費 |
    | 交際費 | 5000 | 変動費 |
    | 水道光熱費 | 7560 | 固定費 |
    
    CASEには、もう1つ似た形の構文が用意されています。
    
- **CASE演算子の利用構文(2)**
    
    ```sql
    CASE WHEN 条件1　THEN 条件1のときに返す値
         (WHEN 条件2 THEN 条件2のときに返す値)...
         (ELSE デフォルト値)
     END
    ```
    
    CASEのすぐ後ろに列名や式を記述しません。その代わり、WHENの後ろには値ではなく条件式を記述します。
    
    - リスト5-6 CASE演算子を使ったSELECT文(2)
    
    ```sql
    /* 条件に応じた値に変換する */
    SELECT 費目, 入金額,
           CASE WHEN 入金額 < 5000 THEN 'お小遣い'
                WHEN 入金額 < 100000 THEN '一時収入'
                WHEN 入金額 < 300000 THEN '給料出たー！'
                ELSE '想定外の収入です！'
           END AS 収入の分類
      FROM 家計簿
     WHERE 入金額 > 0
    ```
    
    | 費目 | 入金額 | 収入の分類 |
    | --- | --- | --- |
    | 給料 | 280000 | 給料出たー！ |

</details>


<details><summary>5.3 さまざまな関数</summary>
 
### 5.3.1 関数とは
    
関数を使えば、四則演算だけでなくもっと高度で複雑なことができます。

多くのデータベースには、より高度な処理を行いやすくするために関数と総称される命令がたくさん準備されています。

すべての関数は「呼び出し時に指定した情報(引数)に対して、定められた処理を行い、結果(戻り値)に変換する」という動作をします。たとえば、LENGTHという命令は、ある文字列をその文字列の長さ(文字数など)に変換する機能を持っています。
    
### 5.3.2 関数の使い方
    
すべての関数には、次の3つのことが定められています。

- **関数について定められていること**

 名前：その関数の名前

 引数：その関数を呼び出す際に引き渡す情報(関数によっては2つ以上の場合もある)

 戻り値：その関数の呼び出し結果として得られる情報


使いたいと思う関数を見つけたら、これら3つの事柄を確認することが重要です。たとえば、既に紹介したLENGTH関数については、次にように定められています。

- **LENGTH関数の仕様**
        
 名前：LENGTH

 引数：文字列が格納された列(または式)

 戻り値：文字列の長さを表す数値


関数を呼び出すには、SQL文の中で次のような構文に従って記述します。
    
- **関数の呼び出し**

 ```sql
 関数の名前(引数...)
 ```

- リスト5-7 メモとメモの長さを併せて表示させる

 ```sql
 SELECT メモ, LENGTH(メモ) AS メモの長さ
   FROM 家計簿
 ```
        
 | メモ | メモの長さ |
 | --- | --- |
 | コーヒーを購入 | 7 |
 | 1月の給料 | 5 |
 | 書籍を購入 | 5 |
 | 同期会の会費 | 6 |
 | 1月の電気代 | 6 |

 この例で使用している関数LENGTHは、受け取った引数の文字数を戻り値としてかえしています。本書では、以後、関数の機能を次のように表記します。

 - **本書における関数の表記(凡例)**

     ```sql
     関数名(引数) => 戻り値
     ```
            
        
 尚、リスト5-7は選択列リストにおける関数を利用した例ですが、ほかにもWHERE句の条件式の一部など、関数はさまざまな場所で利用することができます。
        
### 5.3.3 関数が動作する流れ

関数を自由自在に使いこなすためには、関数の呼び出しがどのように処理されていくかをしっかりと理解しておく必要があります。

まず重要なのが、式の評価と同様に、関数の呼び出しも各行ごとに繰り返し行われているという点です。「LENGTH(メモ)」という呼び出しは、複数の値を一度に処理するのではなく、1行ずつ繰り返し調べます。

次に重要なのが、関数の呼び出しの記述は、呼び出し完了後に戻り値に「化ける」ことです。この特性を利用して、関数の呼び出しを入れ子にすることもできます。
    
### 5.3.4 関数にまつわる注意点
    
関数はDBMS製品ごとの違いが大きく互換性が少ない分野です。

そこで次節からは、多くのDBMSで共通して利用できる代表的な関数を紹介します。本書で紹介する以外にどのような関数が利用できるか、より厳密な文法はどのようになっているかなどは、本書の付録Aや、各DBMS製品のマニュアルを確認するようにしてください。

- **関数はDBMSによって大きく異なる**

 関数については、DBMS製品によって構文が大きく異なるため、詳細は製品マニュアルを参照する必要がある。

- **ユーザー定義関数とストアドプロシージャ**

 あらかじめ用意された関数だけでなく、必要とする処理を自分で記述して作成した関数をSQL文から利用することができます。これをユーザー定義関数と呼びます。また、実行する複数のSQL文をまとめ、プログラムのようなものとしてDBMS内に保存し、データベースの外部から呼び出すものをストアドプロシージャといいます。

 ユーザー定義関数やストアドプロシージャは、DBMS製品ごとに定められたプログラミング言語を使って記述します。たとえば、Oracle DBではPL/SQL、SQL ServerではTransact-SQLという専用言語を用います。また、CやJavaのような一般的なプログラミング言語による記述をサポートしているDBMS製品も存在します。

 多数のSQL文からなる処理を1つのストアドプロシージャにまとめることで、データベースとアプリケーション間のやり取りを少なくし、ネットワークの負荷を軽減できるといったメリットがあります。</details>


<details><summary>5.4 文字列にまつわる関数</summary>

### 5.4.1 LENGTH/LEN — 長さを得る
LENGTH関数は、文字列の長さを調べてくれる関数です。SQL Serverでは、LENGTHの代わりにLEN関数を利用します。テーブルの列に格納されている文字列の長さを取得したり、文字列の長さで絞り込み検索を行いたい場合に利用します。
- **文字列の長さを得る関数**
    
    ```sql
    LENGTH(文字列の表す列) → 文字列の長さを表す数値
    LEN(文字列の表す列) → 文字列の長さを表す数値
    # DBMS製品によって、結果は文字数かバイト数になる
    ```
    
    たとえば、10文字または10バイト以下のメモだけを取得するSQL文は次のリストのようになります。
    
    - リスト5-8 10文字(10バイト)以下のメモだけを取得する
        
        ```sql
        SELECT メモ, LENGTH(メモ)　AS　メモの長さ FROM 家計簿 # 家計簿テーブルから列メモを抽出、さらにLENGTH関数で抽出した列メモの列の名前を「メモの長さ」とする
         WHERE LINGTH(メモ) <= 10 # 列メモから10文字以下のメモを抽出する
        ```
        
### 5.4.2 TRIM — 空白を除去する
ある文字列の前後についている、余計な空白を除去したい場合に便利な関数がTRIM関数です。類似する機能を持つLTRIM関数やRTRIM関数と合わせて覚えておきましょう。
- **空白を除去する関数**
    
    ```sql
    TRIM(文字列を表す列) → 左右から空白を除去した文字列
    LTRIM(文字列を表す列) → 左側の空白を除去した文字列
    RTRIM(文字列を表す列) → 右側の空白を除去した文字列
    ```
    
    たとえばCHAR(10)型の列に対して'abc’という文字列を格納すると、7文字文の空白が右側に自動的に追加され’abc       ‘という文字列として格納されることは第2章で学びました(p049)。そのような文字列をSELECT文でそのまま抽出すると、abcの後ろに空白がついた状態で取得してしまいます。
    
    このような場合に、TRIM関数を使うことで、余計な空白を簡単に削除することができます。
    
    - リスト5-9 空白を除去したメモを取得する
    
    ```sql
    SELECT メモ, TRIM(メモ) AS 空白除去したメモ # 列メモを抽出、さらにTRIM関数でメモを取得し、「空白除去したメモ」と列名を命名
      FROM 家計簿 # 家計簿テーブルから
    ```
    
### 5.4.3 REPLACE — 指定文字を置換する
REPLACE関数は、文字列の一部を別の文字列に置換する関数です。たとえば、文字列「axxle」の「x」を「p」に置換し、「apple」とすることができます。
- **文字列を置換する関数**
    
    ```sql
    REPLACE(置換対象の文字列, 置換前の部分文字列, 置換後の部分文字列) → 置換処理された後の文字列
    ```
    
    次のリストは、メモ列に入っている「購入」という文字列をすべて「買った」に置き換えるUPDATE文です。
    
    - リスト5-10 メモの一部を置換する
    
    ```sql
    UPDATE 家計簿 # 家計簿テーブルをアップデート
       SET メモ = REPLACE(メモ, '購入', '買った') # メモ列を選択、メモ列内にある文字列「購入」を文字列「買った」に置換する
    ```
    
### 5.4.4 SUMSTRING/SUBSTR — 一部を抽出する
文字列の一部分だけを取り出したい場合には、SUBSTRING関数またはSUBSTR関数を利用します。どちらを利用できるかは、DBMS製品によって異なりますが、「何文字目から何文字分」という指定をして文字列の一部文を抽出できる点では違いはありません。
- **文字列の一部を抽出する関数**
    
    ```sql
    SUBSTRING(文字列を表す列, 抽出を開始する位置, 抽出する文字の数) → 抽出された部分文字列
    SUBSTR(文字列を表す列, 抽出を開始する位置, 抽出する文字の数) → 抽出された部分文字列
    # 抽出する文字の数を省略し、文字列の最後までを抽出対象とする場合もある
    # DBMS製品によって、文字数指定かバイト数指定かは異なる。
    ```
    
    - リスト5-11 費目列の1~3文字目に「費」があるものだけを抽出する
    
    ```sql
    SELECT * FROM 家計簿 # 家計簿テーブルから全ての列を選択
     WHERE SUBSTRING(費目, 1, 3) LIKE '%費%' # 費目列の1~3文字目に「費」があるものだけを抽出する
    ```
    
### 5.4.5 CONCAT — 文字列を連結する
文字列を連結するには、通常、||演算子や+演算子を使いますが、環境によってはCONCAT関数を利用できます。連結できる文字列の数やNULLの扱いがDBMS製品によって異なりますので注意してください。
- **文字列を連結する関数**
    
    ```sql
    CONCAT(文字列, 文字列[, 文字列...]) → 連結後の文字列
    # SQL ServerやMySQLなどでは3つ以上の文字列を指定することが可能
    # 1つでもNULLの文字列があるとNULLを返すDBMS製品もある
    ```
    
    - リスト5-12 費目とメモを繋げて抽出する
    
    ```sql
    SELECT CONCAT(費目, ':' || メモ)　FROM　家計簿 # 家計簿テーブルから「費目」と「メモ」を繋げて、その間には「:」コロンを挿入する
    ```
</details>

# 第10章 テーブルの作成
これまでは、既存のテーブルに対するデータの格納や取り出しの命令を学んできました。

この章では、新しいテーブルを作成する命令を学びます。

しかし、単にテーブルの作成方法だけを学ぶわけではありません。

テーブル作成に伴う様々なオプションについての知識を身につけ、データベースが提供してくれる機能や高い信頼性を実現するための仕組みも理解していきましょう。

<details><summary>10.1 SQL命令の種類</summary>

### 10.1.1 データベースを使う2つの立場
これまで、SELECT、INSERT、UPDATE、DELETEなどの命令を使って、既存のテーブルに対してデータを操作する方法を学びました。今回の学習では、入力したSQL文を直接DBMSに送っていますが、一般的な情報システムの内部では、Javaなどで開発したプログラムが生成したSQL文をDBMSに送ってデータ操作を指示することが大半です。

つまり、これまでの私たちや情報システムにおけるプログラムは、「**データの操作を支持する立場**(立場①)」としてDBMSを利用しています。

しかし、立場①の人がSELECT文やINSERT文でデータの出し入れを行うには、そもそもデータベース内部にテーブルが存在していることを前提としています。そこで必要になるのが、テーブルの作成や各種の設定など、「**データベース自体の操作を指示する立場**(立場②)」の存在です。

- **データベースを利用する2つの立場**
    
    立場①：データベースにデータの出し入れを指示する立場
    
    立場②：立場①の人が、効率良く、安全にデータの出し入れができるよう必要なテーブル準備や各種設定を指示する立場
この章からは立場②として**データベースの設定や構築についての方法**を学んでいきます。

### 10.1.2  4種類の命令
立場②としてテーブル作成を指示する場合にも、SQLを使います。但し、SELECTやINSERTではなく、CREATE TABLEという命令を使います。立場②として使う命令は他にもたくさん準備されていますが、すべてのSQL文は、最終的に4種類の命令に分類することができます。

### 10.1.3 DCLとは
DCLは、誰に、どのようなデータ操作やテーブル操作を許すかといった権限を設定するためのSQL命令の総称です。権限を付与するGRANT文と剥奪するREVOKE文があります。
- **GRANT文とREVOKE文**
    
    ```sql
    GRANT 権限名 TO ユーザー名
    REVOKE 権限名 FROM ユーザー名
    # 権限名やユーザー名の記述の詳細は、DBMS製品によって異なる。
    ```

これらは、立場②の中でも特にデータベースの全権を管理する、**データベース管理者**(DBA:Database Administrator)の立場の人だけが使う命令です。また、DBMS製品によって構文や位置付けが大きく異なるため、詳細は各製品のマニュアルに譲ることにします。

### SQL文の分類方法
あるSQL文が、DML、TCL、DDL、DCLのいずれに分類されるかは、DBMS製品や資料によって異なることがあります。

例えば、BEGIN、COMMIT、ROLLBACKは、DCLに分類される場合もあります。</details>


<details><summary>10.2 テーブルの作成</summary>

### 10.2.1 テーブル作成の基本
テーブルを作成するには、CREATE TABLE文を使います。作成したいテーブルの名前、テーブルを構成する列と型の一覧を指定し、テーブルを定義します。
- **テーブルの作成(基本形)**
    
    ```sql
    CREATE TABLE テーブル名 (
      列名1 列1の型名,
      列名2 列2の型名,
      ：
      列名X 列Xの型名
    )
    ```
    

例えば、これまで利用してきた家計簿テーブルを作成するには、リスト10-1のようなSQL文を実行します。

- リスト10-1 家計簿テーブルを作成する

```sql
CREATE TABLE 家計簿 (
  日付        DATE,
  費目ID      INTEGER,
  メモ        VARCHAR(100),
  入金額      INTEGER,
  出金額      INTEGER
)
```

### 10.2.2 デフォルト値の指定
テーブルに対してINSERT文によって行が追加される際、一部の列の値が指定されないことがあります。例えば、家計簿テーブルに行を追加する次のリスト10-2のように、「費目ID」や「入金額」が省略されるかもしれません。
- リスト10-2 家計簿テーブルに対する行の追加

```sql
INSERT INTO 家計簿 (日付, メモ, 出金額）
     VALUES ('2018-04-12', '詳細は後で', 60000)
```

このSQL文が実行されると、テーブルに追加された行の「費目ID」と「入金額」の列の内容は、次の結果表にあるようにNULLとなります。

| 日付 | 費目ID | メモ | 入金額 | 出金額 |
| --- | --- | --- | --- | --- |
| 2018-04-12 | NULL | 詳細は後で | NULL | 60000 |

**INSERT文で具体的な値を指定しなかった場合に、NULLではなく特定のデフォルト値(初期値)を格納**できたら便利だと思いませんか。テーブルを作成する際に、デフォルト値を決めておくことで、「特に指定しなければ入金額には0が格納される」というような設定を行うことが可能です。

そのためには、CREATE TABLE文にDEFAULTキーワードを指定します。
- **デフォルト値の指定を含むテーブルの作成**
    
    ```sql
    CREATE TABLE テーブル名 (
      列名  型名 DEFAULT デフォルト値,
      :
    )
    ```
    

この仕組みを活用して家計簿テーブルを作成するには、次のSQL文を実行します。4〜6行目で、デフォルト値として0や「不明」を指定しています。

- リスト10-3 家計簿テーブルを作成する(デフォルト値を活用)

```sql
CREATE TABLE 家計簿 (
  日付        DATE,
  費目ID      INTEGER,
  メモ        VARCHAR(100) DEFAULT '不明',
  入金額      INTEGER      DEFAULT 0,
  出金額      INTEGER      DEFAULT 0
)
```

### 10.2.3 DROP TABLE文
リスト10-1を実行したまま、リスト10-3の内容を実行するとエラーになります。何故なら、すでに家計簿テーブルが作成されているためです。**データベース内に、同じ名前のテーブルを複数作ることはできません**。つまり、家計簿テーブルを作り直すには、家計簿テーブルをいったん削除しなければなりません。

DELETE文は、DML(Data Manipulation Language)に属する命令です。テーブルのデータの削除はできますが、テーブル自体を削除することはできません。

テーブル自体を削除するにはDDLに属するDROP TABLE文を利用します。
- **テーブルの削除**
    
    ```sql
    DROP TABLE テーブル名
    ```
    
- **DROP TABLEはキャンセルできない？**
    
    DMLに属するDELETE文などは、ロールバック命令によりキャンセルできることが一般的です。しかし、DDLについてロールバックができるか否かはDBMS製品によって異なります。
    
    例えば、Oracle DBでは基本的にDDLはロールバックできず、一度実行すると取り消しすることができません。重要な操作を行う場合には、念の為バックアップしておくなど安全への配慮も大切です。

つまり、この場合は「**DROP TABLE** 家計簿」を実行すればテーブルを削除することが可能です。

### 10.2.4 ALTER TABLE文
テーブル定義の内容を変更するには、ALTER TABLE文を使います。この文では、具体的にテーブルの「何を」「とう」変えるかを指定する必要があります。今回は代表的な2つの変更について紹介しておきます。
- **テーブル定義の変更**
    
    ```sql
    ・列の追加
    ALTER TABLE テーブル名 ADD 列名 型 制約
    
    ・列の削除
    ALTER TABLE テーブル名 DROP 列名 型 制約
    ```
    

既存のテーブルに列を追加する場合、挿入される位置は、原則として一番最後になります。DBMSによっては、挿入位置を任意に指定できるものもあります。

例えば、家計簿テーブルにDATE型の「関連日」列を追加してすぐ削除するには、リスト10-4のようなSQL文を実行します。

- リスト10-4 列の追加と削除

```sql
-- 追加するとき
ALTER TABLE 家計簿 ADD 関連日 DATE;

-- 削除するとき
ALTER TABLE 家計簿 DROP 関連日;
```

### 全件のデータを高速に削除する
テーブルの全行を削除する場合、**TRUNCATE TABLE文**が利用されることがあります。

```sql
TRUNCATE TABLE 家計簿      -- 家計簿テーブルの全行を削除
```

実行結果は「DELETE FROM 家計簿」とほぼ同じですが、その動作には次のような違いがあります。

- DELETEはWHERE句で指定した行だけ削除できるが、TRUNCATEは必ず全行を削除する。
- DELETEはDMLだが、TRUNCATEはDDLに属する命令である。
- DELETEはロールバックに備えて記録を残しながら仮削除していくが、TRUNCATEは記録を残さずに行を削除する(よってロールバックできない)。

TRUNCATE TABLEは、厳密にはデータ削除ではなくテーブル初期化の命令です。「テーブルを一度DROPして同じものをCREATEする」というような動作イメージを持つとわかりやすいでしょう。</details>


<details><summary>10.3 制約</summary>

### 10.3.1 人為的ミスに備える
**データベース本来の役割を考えると、テーブルに異常な値が格納されてしまうことは絶対に避けなければなりません**。第9章では、**予期しない中断や同時実行など、システム的な理由でデータが異常な状態になってしまうことを避けるため**に**トランザクション**を使うことを学びました。

しかしデータベースの利用者が、文法としては正しいものの、システムの意図としては誤ったSQL文をDBMSに送ってしまうような**人為的ミスに対してトランザクション制御は全くの無力**です。

DBMSは、人為的ミスによる意図しないデータの格納が行われないための仕組みをいくつも備えています。例えば、「型」もそんな安全機構の1つです。

テーブルの各列に型を指定することで、その列に格納できるデータの種類は制限されるようになります。型など指定せず、文字列でも数値でも格納できたほうが便利と感じる人もいるかもしれません。しかし、例えば「出金額」の列がINTEGER型で定義されているからこそ、万が一にも誤って文字列を格納してしまう人為的ミスを回避できるのです。
- **あえて制限することで安全性を高める**
    
    予期しない値を格納できないように制限をかけることで、人為的ミスによるデータ破壊の可能性を減らすことができる。

加えて、多くのDBMSは**制約**(constraint)という仕組みを備えており、型よりもさらに強力な制限をかけることができます。制約を使えば、「日付の列は絶対にNULLになってはならない」や「入金額や出金額の列は0以上の数値しか格納してはならない」のようなきめ細かい制限をかけることができます。

現在、広く用いられているDBMSでは5種類の制約をサポートしています。先ずはその中から、比較的シンプルな3つについて紹介していきましょう。

### 10.3.2 基本的な3つの制約
制約は、CREATE TABLE文でテーブルを定義する際に、列定義の末尾に指定することが可能です。

# 第10章 テーブルの作成
これまでは、既存のテーブルに対するデータの格納や取り出しの命令を学んできました。

この章では、新しいテーブルを作成する命令を学びます。

しかし、単にテーブルの作成方法だけを学ぶわけではありません。

テーブル作成に伴う様々なオプションについての知識を身につけ、データベースが提供してくれる機能や高い信頼性を実現するための仕組みも理解していきましょう。

<details><summary>10.1 SQL命令の種類</summary>

### 10.1.1 データベースを使う2つの立場
これまで、SELECT、INSERT、UPDATE、DELETEなどの命令を使って、既存のテーブルに対してデータを操作する方法を学びました。今回の学習では、入力したSQL文を直接DBMSに送っていますが、一般的な情報システムの内部では、Javaなどで開発したプログラムが生成したSQL文をDBMSに送ってデータ操作を指示することが大半です。

つまり、これまでの私たちや情報システムにおけるプログラムは、「**データの操作を支持する立場**(立場①)」としてDBMSを利用しています。

しかし、立場①の人がSELECT文やINSERT文でデータの出し入れを行うには、そもそもデータベース内部にテーブルが存在していることを前提としています。そこで必要になるのが、テーブルの作成や各種の設定など、「**データベース自体の操作を指示する立場**(立場②)」の存在です。

- **データベースを利用する2つの立場**
    
    立場①：データベースにデータの出し入れを指示する立場
    
    立場②：立場①の人が、効率良く、安全にデータの出し入れができるよう必要なテーブル準備や各種設定を指示する立場
この章からは立場②として**データベースの設定や構築についての方法**を学んでいきます。

### 10.1.2  4種類の命令
立場②としてテーブル作成を指示する場合にも、SQLを使います。但し、SELECTやINSERTではなく、CREATE TABLEという命令を使います。立場②として使う命令は他にもたくさん準備されていますが、すべてのSQL文は、最終的に4種類の命令に分類することができます。

### 10.1.3 DCLとは
DCLは、誰に、どのようなデータ操作やテーブル操作を許すかといった権限を設定するためのSQL命令の総称です。権限を付与するGRANT文と剥奪するREVOKE文があります。
- **GRANT文とREVOKE文**
    
    ```sql
    GRANT 権限名 TO ユーザー名
    REVOKE 権限名 FROM ユーザー名
    # 権限名やユーザー名の記述の詳細は、DBMS製品によって異なる。
    ```

これらは、立場②の中でも特にデータベースの全権を管理する、**データベース管理者**(DBA:Database Administrator)の立場の人だけが使う命令です。また、DBMS製品によって構文や位置付けが大きく異なるため、詳細は各製品のマニュアルに譲ることにします。

### SQL文の分類方法
あるSQL文が、DML、TCL、DDL、DCLのいずれに分類されるかは、DBMS製品や資料によって異なることがあります。

例えば、BEGIN、COMMIT、ROLLBACKは、DCLに分類される場合もあります。</details>


<details><summary>10.2 テーブルの作成</summary>

### 10.2.1 テーブル作成の基本
テーブルを作成するには、CREATE TABLE文を使います。作成したいテーブルの名前、テーブルを構成する列と型の一覧を指定し、テーブルを定義します。
- **テーブルの作成(基本形)**
    
    ```sql
    CREATE TABLE テーブル名 (
      列名1 列1の型名,
      列名2 列2の型名,
      ：
      列名X 列Xの型名
    )
    ```
    

例えば、これまで利用してきた家計簿テーブルを作成するには、リスト10-1のようなSQL文を実行します。

- リスト10-1 家計簿テーブルを作成する

```sql
CREATE TABLE 家計簿 (
  日付        DATE,
  費目ID      INTEGER,
  メモ        VARCHAR(100),
  入金額      INTEGER,
  出金額      INTEGER
)
```

### 10.2.2 デフォルト値の指定
テーブルに対してINSERT文によって行が追加される際、一部の列の値が指定されないことがあります。例えば、家計簿テーブルに行を追加する次のリスト10-2のように、「費目ID」や「入金額」が省略されるかもしれません。
- リスト10-2 家計簿テーブルに対する行の追加

```sql
INSERT INTO 家計簿 (日付, メモ, 出金額）
     VALUES ('2018-04-12', '詳細は後で', 60000)
```

このSQL文が実行されると、テーブルに追加された行の「費目ID」と「入金額」の列の内容は、次の結果表にあるようにNULLとなります。

| 日付 | 費目ID | メモ | 入金額 | 出金額 |
| --- | --- | --- | --- | --- |
| 2018-04-12 | NULL | 詳細は後で | NULL | 60000 |

**INSERT文で具体的な値を指定しなかった場合に、NULLではなく特定のデフォルト値(初期値)を格納**できたら便利だと思いませんか。テーブルを作成する際に、デフォルト値を決めておくことで、「特に指定しなければ入金額には0が格納される」というような設定を行うことが可能です。

そのためには、CREATE TABLE文にDEFAULTキーワードを指定します。
- **デフォルト値の指定を含むテーブルの作成**
    
    ```sql
    CREATE TABLE テーブル名 (
      列名  型名 DEFAULT デフォルト値,
      :
    )
    ```
    

この仕組みを活用して家計簿テーブルを作成するには、次のSQL文を実行します。4〜6行目で、デフォルト値として0や「不明」を指定しています。

- リスト10-3 家計簿テーブルを作成する(デフォルト値を活用)

```sql
CREATE TABLE 家計簿 (
  日付        DATE,
  費目ID      INTEGER,
  メモ        VARCHAR(100) DEFAULT '不明',
  入金額      INTEGER      DEFAULT 0,
  出金額      INTEGER      DEFAULT 0
)
```

### 10.2.3 DROP TABLE文
リスト10-1を実行したまま、リスト10-3の内容を実行するとエラーになります。何故なら、すでに家計簿テーブルが作成されているためです。**データベース内に、同じ名前のテーブルを複数作ることはできません**。つまり、家計簿テーブルを作り直すには、家計簿テーブルをいったん削除しなければなりません。

DELETE文は、DML(Data Manipulation Language)に属する命令です。テーブルのデータの削除はできますが、テーブル自体を削除することはできません。

テーブル自体を削除するにはDDLに属するDROP TABLE文を利用します。
- **テーブルの削除**
    
    ```sql
    DROP TABLE テーブル名
    ```
    
- **DROP TABLEはキャンセルできない？**
    
    DMLに属するDELETE文などは、ロールバック命令によりキャンセルできることが一般的です。しかし、DDLについてロールバックができるか否かはDBMS製品によって異なります。
    
    例えば、Oracle DBでは基本的にDDLはロールバックできず、一度実行すると取り消しすることができません。重要な操作を行う場合には、念の為バックアップしておくなど安全への配慮も大切です。

つまり、この場合は「**DROP TABLE** 家計簿」を実行すればテーブルを削除することが可能です。

### 10.2.4 ALTER TABLE文
テーブル定義の内容を変更するには、ALTER TABLE文を使います。この文では、具体的にテーブルの「何を」「とう」変えるかを指定する必要があります。今回は代表的な2つの変更について紹介しておきます。
- **テーブル定義の変更**
    
    ```sql
    ・列の追加
    ALTER TABLE テーブル名 ADD 列名 型 制約
    
    ・列の削除
    ALTER TABLE テーブル名 DROP 列名 型 制約
    ```
    

既存のテーブルに列を追加する場合、挿入される位置は、原則として一番最後になります。DBMSによっては、挿入位置を任意に指定できるものもあります。

例えば、家計簿テーブルにDATE型の「関連日」列を追加してすぐ削除するには、リスト10-4のようなSQL文を実行します。

- リスト10-4 列の追加と削除

```sql
-- 追加するとき
ALTER TABLE 家計簿 ADD 関連日 DATE;

-- 削除するとき
ALTER TABLE 家計簿 DROP 関連日;
```

### 全件のデータを高速に削除する
テーブルの全行を削除する場合、**TRUNCATE TABLE文**が利用されることがあります。

```sql
TRUNCATE TABLE 家計簿      -- 家計簿テーブルの全行を削除
```

実行結果は「DELETE FROM 家計簿」とほぼ同じですが、その動作には次のような違いがあります。

- DELETEはWHERE句で指定した行だけ削除できるが、TRUNCATEは必ず全行を削除する。
- DELETEはDMLだが、TRUNCATEはDDLに属する命令である。
- DELETEはロールバックに備えて記録を残しながら仮削除していくが、TRUNCATEは記録を残さずに行を削除する(よってロールバックできない)。

TRUNCATE TABLEは、厳密にはデータ削除ではなくテーブル初期化の命令です。「テーブルを一度DROPして同じものをCREATEする」というような動作イメージを持つとわかりやすいでしょう。</details>


<details><summary>10.3 制約</summary>

### 10.3.1 人為的ミスに備える
**データベース本来の役割を考えると、テーブルに異常な値が格納されてしまうことは絶対に避けなければなりません**。第9章では、**予期しない中断や同時実行など、システム的な理由でデータが異常な状態になってしまうことを避けるため**に**トランザクション**を使うことを学びました。

しかしデータベースの利用者が、文法としては正しいものの、システムの意図としては誤ったSQL文をDBMSに送ってしまうような**人為的ミスに対してトランザクション制御は全くの無力**です。

DBMSは、人為的ミスによる意図しないデータの格納が行われないための仕組みをいくつも備えています。例えば、「型」もそんな安全機構の1つです。

テーブルの各列に型を指定することで、その列に格納できるデータの種類は制限されるようになります。型など指定せず、文字列でも数値でも格納できたほうが便利と感じる人もいるかもしれません。しかし、例えば「出金額」の列がINTEGER型で定義されているからこそ、万が一にも誤って文字列を格納してしまう人為的ミスを回避できるのです。
- **あえて制限することで安全性を高める**
    
    予期しない値を格納できないように制限をかけることで、人為的ミスによるデータ破壊の可能性を減らすことができる。

加えて、多くのDBMSは**制約**(constraint)という仕組みを備えており、型よりもさらに強力な制限をかけることができます。制約を使えば、「日付の列は絶対にNULLになってはならない」や「入金額や出金額の列は0以上の数値しか格納してはならない」のようなきめ細かい制限をかけることができます。

現在、広く用いられているDBMSでは5種類の制約をサポートしています。先ずはその中から、比較的シンプルな3つについて紹介していきましょう。

### 10.3.2 基本的な3つの制約
制約は、CREATE TABLE文でテーブルを定義する際に、列定義の末尾に指定することが可能です。
- **CREATE TABLE文中における制約の指定**
    
    ```sql
    CREATE TABLE テーブル名 (
      列名  型 制約の指定,
    	:
    )
    ```

尚、制約を複数指定することもできますが、カンマで区切らずにそのまま並べて記述します。

例えば、図10-4のようなデータを格納するために2つのテーブルを作成したい場合を考えます。この例の場合、制約の指定を伴う次のようなCREATE TABLE文を実行します。
- リスト10-5 基本的な3つの制約を活用

```sql
CREATE TABLE 家計簿 (
  日付      DATE         NOT NULL, # NOT NULL 制約
  費目ID    INTEGER,
  メモ      VARCHAR(100) DEFAULT '不明' NOT NULL,　# NOT NULL 制約
  入金額    INTEGER      DEFAULT 0 CHECK(入金額 >= 0),　# CHECK 制約
  出金額    INTEGER      DEFAULT 0 CHECK(出金額 >= 0) # CHECK 制約
);
CREATE TABLE 費目 (
  ID       INTEGER,
  名前      VARCHAR(40)  UNIQUE # UNIQUE 制約
);
```

このリストでは、NOT NULL、CHECK、UNIQUEという基本的な3種類の制約が使われています。

- **[その1] NOT NULL制約**
    - **NOT NULL制約**が設定された列には、NULLの格納は許可されません。例えば、家計簿テーブルがリスト10-5のようにして作られた場合、この節の最初に日付を指定せずにINSERTを実行するとエラーが発生して行の追加が失敗します。**※制約のおかげで、意図しない処理を中断してくれる。**
    - 尚、リスト10-5の「メモ」列のように、**NOT NULL制約はDEFAULT指定と組み合わせて利用**されることがほとんどです。デフォルト値が設定されていれば、INSERT文で特に値を入力しなくても自動的にその値が設定されるため、エラーにならないからです(リスト10-6)。
- リスト10-6 デフォルト値が設定されていれば、エラーにならない

```sql
-- メモを明示的に指定して INSERT → '家賃' が入る
INSERT INTO 家計簿 (日付, 費目ID, メモ, 入金額, 出金額)
     VALUES ('2018-04-04', 2, '家賃', 0, 60000);

-- メモを省略してINSERT → '不明' が入る
INSERT INTO 家計簿 (日付, 費目ID, 入金額, 出金額)
     VALUES ('2018-04-05', 3, 0, 1350);
```

**※列にNOT NULL制約がついていれば、複数行副問い合わせの落とし穴についても心配が減る。**

- **[その2] UNIQUE制約**
    - ある列の内容が決して重複してはならない場合、**UNIQUE制約**を付けます。例えば、費目テーブルは家計簿で利用される費目の一覧が格納されるテーブルです。通常、同じ名前の費目が複数あってはならないため、リスト10-5ではこの列にUNIQUE制約が指定されています(図10-5)。

### 10.3.3 主キー制約
主キーの列とは、「その列の値を指定すれば、どの1行のことかを完全に予定できる」という役割を与えられた列のことでした(p097)。リスト10-5の費目テーブルでいえば、「ID」列が主キーの役割を期待されている列でしょう。

そして、主キーがその役割を果たすためには、「他の行と重複してはならない」「必ず値が格納されなければならない(NULLであってはならない)」という2つの性質を満たさなければならないことも学びました。

主キータの役割を担う列には、主キー制約(PRIMARY KEY制約)を付けましょう。この制約がついている列は、単なる「NULLも重複も許されない列」ではなく、主キーとしての役割が期待されているという意味(セマンティクス)を持ちます。

主キー制約をつける方法は2つあります。ある単独の列に指定したい場合は、他の制約と同様、列名の末尾に記述します。
- リスト10-7 主キー制約の指定(1)

```sql
CREATE TABLE 費目 (
  ID   INTEGER        PRIMARY KEY, #PRIMARY KEYは主キー制約
  名前  VARCGAR(40)    UNIQUE
)
```

この記法を用いる場合、複数の列に主キー制約を指定することはできません。一方、リスト10-8のようにCREATE TABLE文の最後に記述する記法を用いれば複合主キーの指定も可能です。

- リスト10-8 主キー制約の指定(2)

```sql
CREATE TEBLE 費目 (
  ID   INTEGER,
  名前  VARCGAR(40)   UNIQUE,
  PRIMARY KEY(ID, 名前) # ID列と名前列で複合主キーを構成する
)
```

主キー列に関しては、万が一にもNULLや重複値が格納されると行が識別できないという致命的な状況に陥るため、**特別な理由がない限り、主キー制約を指定するようにしましょう**。</details>


<details><summary>10.4 外部キーと参照整合性</summary>

### 10.4.1 参照生合成の崩壊
外部キーが指し示す先にきちんと行が存在してリレーションシップが成立していることを参照整合性(referential integrity)といいます。逆に外部キーが指し示す先に行が存在しない状態になってしまうことを「参照整合性の崩壊」といわれ、データベース利用において絶対に避けなければならないことです。
- **参照整合性の崩壊**
    
    外部キーで別テーブルの行を参照しているのに、その行が存在しない状態をいう。このような状態になることは、絶対に避けなければならない。

### 10.4.2 崩壊の原因
どのようなSQLを実行すると参照整合性が崩壊してしまうのか、4つのパターンがあります。
- **参照整合性の崩壊を引き起こすデータ操作**
    1. 「他の行から参照されている」行を削除してしまう。
    2. 「他の行から参照されている」行の主キーを変更してしまう。
    3. 「存在しない行を参照する」行を追加してしまう。
    4. 「存在しない行を参照する」行に更新してしまう。

具体的に、図10-7の例で参照整合性を崩す4つのSQL文を次に表します。リストのコメントの丸数字は、左ページ下の4つのパターンを示します。
- リスト10-9 参照整合性制約を崩す例

```sql
-- 1.家計簿テーブルで利用中の費目について、費目テーブルから削除
DELETE FROM 費目 WHERE ID = 2;

-- 2.家計簿テーブルで利用中の費目について、費目テーブルのIDを変更
RPDATE 費目 SET ID = 5 WHERE ID = 1;

-- 3.家計簿テーブルに行を追加する際、費目テーブルに存在しない費目を指定
INSERT INTO 家計簿 (日付, 費目ID, 入金額, 出金額)
     VALUES ('2018-04-06', 99, 0, 800);

-- 4.家計簿テーブルの行を更新する際、費目テーブルに存在しない費目を指定
UPDATE 家計簿 SET 費目ID = 99
 WHERE 日付 = '2018-04-10';
```

### 10.4.3 外部キー制約
※人によるミスを防ぐには、「制約」。

参照整合性が崩れるようなデータ操作をしようとした場合にエラーを発生させ、強制的に処理を中断させる制約が外部キー制約(FOREIGN KEY制約)です。この制約は、参照元のテーブルの外部キー列に設定します。
- **外部キー制約の指定(1)**
    
    ```sql
    CREATE TABLE テーブル名 (
        列名  型   REFERENCES 参照先テーブル名(参照先列名)
        :
    )
    ```
    

家計簿テーブルに外部キー制約をかけるには、次のように記述します。

- リスト10-10 外部キー制約の指定

```sql
CREATE TABLE 家計簿 )
  日付   DATE           NOT NULL,
  費目ID INTEGER        REFERENCES 費目(ID), # 外部キー制約
  メモ   VARCHAR(100)   DEFAULT '不明' NOT NULL,
  入金額 INTEGER        DEFAULT 0 CHECK(入金額 >= 0),
  出金額 INTEGER        DEFAULT 0 CHECK(出金額 >= 0)
)
```

主キーの場合と同様に、CREATE TABLE文の最後にまとめて定義することも可能です。この場合は、「FOREIGN KEY」で制約を付ける列を指定します。
- 外部キー制約の指定(2)
    
    ```sql
    CREATE TABLE テーブル名 (
      :
       FOREIGN KEY(参照元列名) REFERENCES 参照先テーブル名(参照先列名)
    )
    ```
    
    こちらの構文を用いる場合の家計簿テーブルの例では、費目IDの列定義には制約を記述しない代わりに、最後に「FREIGN KEY(費目ID) REFERENCES 費目(ID)」という記述を加えることになるでしょう。

### 制約がついていなくても「主キー」
主キー制約がついている列は、主キーの列です。しかし、**この制約が付いていないからといって、主キーの列ではないとは言い切れません**。

主キー制約は、あくまでもその列に「主キーであれば果たすべき2つの責任(非NULL、および重複なし)を確実に果たさせるための安全装置」に過ぎません。制約が設定されていなくても、利用者が「行を識別するための列」として利用する列があれば、それは主キー列です。</details>


<details><summary>10.5 この章のまとめ</summary>

### 10.5.1 この章で学習した内容
- **4種類のSQL命令**
    - データを格納したり取り出したりする場合は、DMLに属する命令を使う。
    - データを格納するテーブル自体を作成したり削除したりする場合は、DDLに属する命令を使う。
    - トランザクションの開始や終了を指示する場合は、TCLに属する命令を使う。
    - DMLやDDLに関する許可や禁止を設定する場合は、DCLに属する命令を使う。
- **テーブルの作成と削除**
    - CREATE TABLE文を用いて、新規のテーブルを作成できる。
    - テーブル作成時に、列にデフォルト値を指定できる。
    - DROP TABLE文でテーブルを削除できる。
- **制約**
    - テーブル作成時に各列に制約を設定し、予期しない値が格納されないようにすることができる。
    - NOT NULL制約は、NULLの格納を防ぐことができる。
    - UNIQUE制約は、重複した値の格納を防ぐことができる。
    - CHECK制約は、格納しようとする値が妥当かどうかをチェックできる。
    - 主キーとして取り扱いたい列には、主キー制約を設定する。
    - データの更新や削除によって外部キーによる参照整合性が崩れることがないように、外部キー制約を設定する。

### 10.5.2 この章でできるようになったこと
- 「ID」列を主キーとする費目テーブルを作りたい。

```sql
CREATE TABLE 費目 (
    ID  INTEGER     PRIMARY KEY,
    名前 VARCHAR(40) UNIQUE
)
```

- 適切な制約を設定した家計簿テーブルを作りたい。

```sql
CREATE TABLE 家計簿 (
  日付    DATE         NOT NULL,
  費目ID  INTEGER      REFERENCES 費目(ID),
  メモ    VARCHAR(100) DEFAULT '不明' NOT NULL,
  入金額  INTEGER      DEFAULT 0 CHECK(入金額 >= 0),
  出金額  INTEGER      DEFAULT 0 CHECK(出金額 >= 0)
)
```

- 費目テーブルに「備考」列を追加したい。

```sql
ALTER TABLE 費目 ADD 備考 VARCHAR(50)
```

- 家計簿テーブルを削除したい。

```sql
DROP TABLE 家計簿
```

</details>

# 第4章 検索結果の加工
SELECT文は基本的に、抽出の対象である選択列リスト、抽出元であるFROM句、抽出の条件であるWHERE句から成り立っています。

さらにSELECT文には、検索した結果を加工し、目的に合わせた形に整形する指示を加えることもできます。

この章ではSELECT文にスポットを当て、その多様な修飾方法を見ていきましょう。


<details><summary>4.1 検索結果の加工</summary>

### 4.1.1 SELECT文だけに可能な修飾
SQLの4大命令
| 命令 | 各命令で固有の部分 | 対象行の絞り込み | 検索結果の加工 |
| --- | --- | --- | --- |
| SELECT | 列名…FROM　テーブル名 | WHERE | その他修飾 |
| UPDATE | テーブル名　SET　列名　=　値… | WHERE |  |
| DELETE | FROM　テーブル名 | WHERE |  |
| INSERT | INTO　テーブル名(列名…)　VALUES(値…) |  |  |
前章では、INSERT文以外のSQLに共通して利用可能なWHERE句について学びました。そして第Ⅰ部最後のこの章では、さらにSELECT文にだけ付けることのできる修飾について紹介していきます。

SELECT文専用の修飾は、どれも「SELECT文によって得られた検索結果をさまざまな形に加工するためのもの」です。多くのDBMSでは、SELECTによる検索とともに加工も行われますが、2段階の処理を考えるとイメージしやすいでしょう。

- ステップ①：通常の検索実行
- ステップ②：検索結果を加工
    - 並び替えや、重複行の排除など

次節からは修飾の具体的な内容として、6つの修飾語を順に紹介していきます。

検索結果を加工する主なキーワード
| キーワード | 内容 | 解説 |
| --- | --- | --- |
| DISTINCT | 検索結果から重複行を除外する | 4.2 節 |
| ORDER BY | 検索結果の順序を並べ替える | 4.3 節 |
| OFFSET - FETCH | 検索結果から件数を限定して取得する | 4.4 節 |
| UNION | 検索結果に他の検索結果を足し合わせる | 4.5 節 |
| EXCEPT | 検索結果から他の検索結果を差し引く | 4.5 節 |
| INTERSECT | 検索結果と他の検索結果で重複する部分を取得する | 4.5 節 |
  </details>


<details><summary>4.2 DISTINCT — 重複行を除外する</summary>

### 4.2.1 値の一覧を得る
DISTINCTキーワードをSELECT分に付加すると、結果表の中で内容が重複している行があれば、その重複を取り除いてくれます。

重複行を除外する

```sql
SELECT DISTINCT 列名...
  FROM テーブル名
```

たとえば、家計簿テーブルから入金額の列のみを抽出する場合、DISTINCTを付けるか付けないかで検索結果が変わってきます。

リスト4-1 DISTINCTを使わないSELECT文

```sql
SELECT 入金額 FROM 家計簿
```

リスト4-2 DISTINCTを使ったSELECT文

```sql
SELECT DISTINCT 入金額
  FROM 家計簿
```

DISTINCTは、データの種類を取得したい場合に役立ちます。たとえば、家計簿テーブルの費目には、「食費」「水道光熱費」「給料」などの支出の記録が何度も登場することが考えられます。このとき、DISTINCTを使って重複を取り除くことで、どのような種類の支出があったかを、一覧で抽出することができます。

リスト4-3 費目一覧の取得

```sql
SELECT DISTINCT 費目 FROM 家計簿
```

- ステップ①：SELECT 費目
- ステップ②：DISTINCT

なお、このDISTINCT修飾は、他の修飾と異なり、SELECT文の最初に記述する必要がありますので注意してください。</details>


<details><summary>4.3 ORDER BY — 結果を並べ替える</summary>

### 4.3.1 並び替えの基本
SELECT文の最後にORDER BY 句を記述すると、指定した列の値を基準として検索結果を並べ替えて取得することができます。

検索結果を並べ替える

```sql
SELECT 列名... FROM テーブル名
 ORDER BY 列名 並び順

※並び順は、ASCまたはDESC(省略するとASCと同じ意味になる)。
```

ORDER BY句はSELECT文の最後に、並び替えの基準とする列名と並び順を指定します。並び順は、昇順にする場合はASC、降順にする場合はDESCを指定します。但し、ORDER BY句の初期値は昇順ですので、並び順の指定を省略すると、結果は昇順になります。

なお、ORDER BY句に文字列を指定すると、DBMSに設定された照合順序(文字コード順、アルファベット順など)を基準として並べ替えられます。

リスト4-4 出金額で昇順となるよう並べ替えて取得する

```sql
SELECT * FROM 家計簿
 ORDER BY 出金額
```

リスト4-5 日付で降順となるよう並べ替えて取得する

```sql
SELECT ※ FROM 家計簿
 ORDER BY 日付 DESC
```

お買い物サイトの「売れ筋ランキング」の表示も、内部ではORDER BYを使っている。

### 4.3.2 複数の列を基準にした並び替え
ORDER BY句による並び替えの際、複数の列をカンマで区切って指定することができます。このような指定を行うと、最初に指定された列で並べ替えて同じ値が複数行あれば、次に指定された列で並び替えが行われます。

たとえば、「原則として入金額の降順で並べ替える。入金額が等しい行については、さらに出金額の降順で並べ替える」という指定をするには、次のようなSQL文を記述します。

リスト 4-6 複数の列で並べ替える

```sql
SELECT * FROM 家計簿
 ORDER BY 入金額 DESC, 出金額 DESC
```

ORDER BY句では、並び替えの基準とする列を列名ではなく列番号で指定することも可能です。列番号とは、選択列リストにおける列の順番のことで、SELECT命令に記述した順に1から数えます。先程のリストを列番号で書き換えてみます。

リスト4-7 列番号を指定するORDER BY句

```sql
SELECT * FROM 家計簿
 ORDER BY 4 DESC, 5 DESC
# 結果表はリスト4-6と同じ
```

テーブルの前列を指定する「＊」を選択列リストに使った場合も、実際に取得の対象となる列に置き換えた列番号を指定します。

ORDER BY句における列指定に列番号を用いる場合、SELECT文の選択列リストの記述を修正すると並び替えの結果にも影響が及ぶ点には注意が必要です。

このような注意があることから、列番号指定を用いる機会はあまり多くはありません。</details>


<details><summary>4.4 OFFSET - FETCH —先頭から数行だけ取得する</summary>

### 4.4.1 OFFSET - FETCH句の利用
検索結果の全行ではなく、並べ替えた結果の一部だけを得られればよいケースもあります。そのような場合、ORDER BY句に続けてOFFSET - FETCH(オフセット-フェッチ)句を付けることによって簡単に実現できます。
- 先頭から数件だけを取得する
    
    ```sql
    SELECT 列名... FROM テーブル名
     ORDER BY 列名...
    OFFSET 先頭から除外する行数 ROWS
    (FETCH NEXT 取得行数 ROWS ONLY)
    # MySQL,MariaDB,SQLiteではサポートされない
    ```
    

OFFSET句には、先頭から除外したい行数を記述します。省略はできませんので、除外せずに1件目から取得したい場合には0を指定しましょう。

FETCH句には、取得したい行数を指定します。FETCH句を省略すると、該当するすべての行が抽出されます。

たとえば、結果の11〜15番目の行だけを取得したい場合は、OFFSET句に10、FETCH句に5を指定することになります。

リスト4-8 出金額の高い順に3件を取得する

```sql
SELECT 費目, 出金額 FROM 家計簿
 ORDER BY 出金額 DESC
OFFSET 0 ROWS
 FETCH NEXT 3 ROWS ONLY
```

リスト4-9 3番目に高い出金額だけを取得する

```sql
SELECT 費目, 出金額 FROM 家計簿
 ORDER BY 出金額 DESC
OFFSET 2 ROWS
 FETCH NEXT 1 ROWS ONLY
```

OFFSET - FETCH句はORDER BY句と併用されることが多い機能ですが、SQL Serverを除き、OFFSET - FETCH句だけでも使用することが可能です。但しその場合は、どのような並び順で帰ってくるかは実行してみるまでわかりません。

なお、OFFSET ~ FETCH句に対応していないDBMSも存在します。行を制限して取得する別の方法も紹介しておきます。これらはいずれもリスト4-8と同等の動きをします。

リスト4-10 取得行を限定するその他の方法

```sql
-- LIMITの利用
   (Db2,MySQL,MariaDB,PostgreSQL,SQLite,H2 Database)
SELECT 費目, 出金額 
  FROM 家計簿
 ORDER BY 出金額 DESC LIMIT 3 # 最後から3つ分の行を抽出
# OFFSETで読み飛ばす行数を指定することも可能
```

</details>


<details><summary>4.5 集合演算子</summary>

### 4.5.1 集合演算子とは
構造がよく似た複数のテーブルにSELECT分をそれぞれ送り、その結果を組み合わせたい場合は、集合演算子を活用することにより、1つのSQL文で目的を達成することができます。

集合演算とは、SELECT命令によって抽出した結果表を1つのデータの集合と捉え、その結果同士を足し合わせたり、共通部分を探したりといったさまざまな演算を行ってくれる仕組みです。SQLでは、3つの集合演算を利用することができます。
1. UNION - 和集合：2つの検索結果を足し合わせたもの
2. EXCEPT(MINUS) - 差集合：最初の検索結果から次の検索結果と重複する部分を取り除いたもの
3. INTERSECT - 積集合：2つの検索結果で重複するもの

**※Oracle DBではEXCEPTの代わりにMINUSを利用。MySQLではUNIONのみ使用可。**


### 4.5.2 UNION — 和集合を求める
UNION演算子は、最も代表的な集合演算子です。2つのSELECT文をUNIONで繋いで記述すると、それぞれの検索結果を足し合わせた結果(和集合)が返されます。
- 2つのSELECT文の結果を足し合わせる
    
    ```sql
    SELECT 文1
     UNION (ALL)
    SELECT 文2
    ```
    

また、UNIONにALLというキーワードを付加すると、和集合の結果に重複行があった場合に動作が違ってきます。UNIONでは重複行を1行にまとめるのに対し、UNION ALLでは重複行をすべてそのまま返します。

リスト4-11 和集合を取得する

```sql
SELECT 費目, 入金額, 出金額 FROM 家計簿
 UNION
SELECT 費目, 入金額, 出金額 FROM 家計簿アーカイブ
 ORDER BY 2, 3, 1
```

集合演算は、選択列リストに記述した列の組み合わせで計算されます。リスト4-11の例では、家計簿テーブルと家計簿アーカイブテーブルにあるすべての行が抽出され、1つの結果表として返ってきました。また、ALLキーワードがついていないため、重複した住居費などの行は、1行だけになっています。

- 集合演算子を使える条件
    
    SELECTの結果を集合演算子でまとめるときは、選択列リストの列数とそれぞれのデータ型が一致していなければならない。
    

つまり、列数とデータ型さえ一致していれば、まったく異なるテーブルや列でもひとまとめにして抽出することができます。

また、1つのテーブルに格納されたデータを複数の異なる条件で抽出したい場合にもUNIONは活用できます。それぞれのWHERE条件を記述したSELECT文を用意し、UNIONで1つのSQL文としてまとめることで、SQLの実行回数を抑えることが可能になります。

1つの集合演算子がまとめることのできる検索結果は2つだけですが、さらに別の集合演算子を記述することによって、3つ以上の検索結果について集合演算させることも可能です。その場合は、UNIONだけでなく、後述する他の種類の集合演算子を組み合わせることもできます。

なお、集合演算子を使ったSQL文でORDER BY句による並び替えをする場合には、次のことに注意してください。

- 集合演算子でORDER BY句を使う時の注意点
    - ORDER BY句は最後のSELECT文に記述する。
    - 列番号以外による指定(列名やASによる別名)の場合、1つめのSELECT文のものを指定する。
- 数が一致しないSELECT文を繋げるテクニック
    
    選択列リストの数が合わないSELECT文で、どうしても集合演算子を使いたい場合は、足りないほうの選択列リストにNULLを追加することで、数を一致させることができます。
    
- DBMSにとって並び替えは大仕事
    
    SELECT文の最後にくっつけるだけで検索結果を並べ替えてくれるORDER BY句はとても便利な機能です。しかし、この並び替えという処理は、DBMSにとってはかなり負荷のかかる作業であることをぜひ頭の片隅に置いておいてください。
    
    性能上のボトルネックになることを防ぐため、第Ⅲ部で紹介するインデックスの併用を推奨しますが、一時的に定量のメモリを消費する可能性もあります。
    
    また、DISTINCTやUNIONも内部的には並び替えを行っていることがあります。これも大量のメモリを消費する可能性があるため、乱用は控えましょう。</details>


<details><summary>4.6 この章のまとめ</summary>

### 4.6.1 この章で学習した内容
検索結果の加工
- SELECT文で取得したデータは、以下のようなさまざま形に加工できる。
- DBMSによって、使うことのできる機能やキーワードが異なる場合がある。

**集合演算子**

- 集合演算子は、複数のSELECT文の結果を使った演算ができる。
- UNIONは、和集合を求める。
- EXCEPT,MINUSは、差集合を求める。
- INTERSECTは、積集合を求める。


### 4.6.2 家計簿DBでできるようになったこと
- これまでに使った費目一覧を、重複を除外して作りたい。

```sql
SELECT DISTINCT 費目 FROM 家計簿
```

- 3月に使った金額を大きい順に取り出したい。

```sql
SELECT * FROM 家計簿
 WHERE 日付 >= '2018-03-01'
   AND 日付 <= '2018-03-31'
 ORDER BY 出金額 DESC
```

- これまでの給料を大きい順に5件だけ取り出したい。

```sql
SELECT * FROM 家計簿
 WHERE 費目 = '給料' ORDER BY 入金額 DESC
OFFSET 0 ROWS FETCH NEXT 5 ROWS ONLY # MySQLではOFFSET 0 ROWS LIMIT 5またはLIMIT 5
```

- 家計簿と、アーカイブにある2月のデータをまとめて日付順に取り出したい。

```sql
SELECT * FROM 家計簿
 UNION
SELECT * FROM 家計簿アーカイブ
 WHERE 日付 >= '2018-02-01'
   AND 日付 <= '2018-02-28'
 ORDER BY 1;
```

- 今月初めて発生した費目を知りたい。

```sql
SELECT 費目 FROM 家計簿
EXCEPT
SELECT 費目 FROM 家計簿アーカイブ
```

</details>

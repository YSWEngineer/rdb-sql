# 第6章 集計とグループ化
第5章では、検索結果のそれぞれの行に対して同じ計算や処理を行える仕組みとして、関数を紹介しました。

この第6章では、検索結果をひとまとめにして集計する方法を学びます。

集計を上手に活用できれば、単にデータを蓄積するだけでなく、蓄積したデータの分析や活用も可能になることを実感してください。

<details><summary>6.1 データを集計する</summary>

### 6.1.1 集計関数とは
集計処理は、次のようなSQL文で簡単に実現できます。
- リスト 6-1 出金額を集計する

```sql
SELECT SUM(出金額) AS 出金額の合計
  FROM 家計簿
```

| 出金額の合計 |
| --- |
| 15740 |

このSQL文で利用されている「SUM」は、検索結果のデータを集計する**集計関数**の1つです。ほかにも、最大値や平均値などを算出する集計関数も存在します。集計関数を使うと、SELECT文による検索結果が集計された形で出力されるようになります。

### 6.1.2 集計関数の特徴
集計関数は、集計の対象となったすべての行に対して1回だけ計算を行い、1つの答えを出します。必然的に、結果表は必ず1行になります。
- **集計関数の特徴**
    - 検索対象の全行をひとまとめに扱い、1回だけ集計処理を行う。
    - 集計関数の結果は、必ず1行になる。</details>


<details><summary>6.2 集計関数の使い方</summary>

### 6.2.1 代表的な集計関数
通常の関数と同様に、DBMS製品によって利用できる集計関数は異なります。しかしほとんどの製品に共通して利用可能なものが、5つの集計関数です。
- 代表的な集計関数

| 分類 | 関数名 | 説明 |
| --- | --- | --- |
| 集計 | SUM | 各行の値の合計を求める |
| 集計 | MAX | 各行の値の最大値を求める |
| 集計 | MIN | 各行の値の最小値を求める |
| 集計 | AVG | 各行の値の平均値を求める |
| 計数 | COUNT | 行数をカウントする |

5つの関数のうち、COUNT関数だけは他の4つと少し特性が異なります。

### 6.2.2 合計、最大、最小、平均を求める
検索結果のある列に対して、合計、最大値、最小値、平均値を求めたい場合、SUM(サム),MAX(マックス),MIN(ミニマム),AVG(アベレージ)関数を利用します。
- 合計、最大値、最小値、平均値を求める集計関数
    
    ```sql
    SUM(列) → 合計
    MAX(列) → 最大値
    MIN(列) → 最小値
    AVG(列) → 平均値
    ```
    
    これらの関数には引数として1つの列名を渡します。また、列名だけではなく「SUM(出金額 * 1.08)」のように、列名を含む式を指定することも可能です。
    
- リスト 6-2 さまざま集計をする
    
    ```sql
    SELECT
        SUM(出金額) AS 合計出金額,
        AVG(出金額) AS 平均出金額,
        MAX(出金額) AS 最も大きな散財,
        MIN(出金額) AS 最も少額の支払い
      FROM 家計簿
    ```
    
    | 合計出金額 | 平均出金額 | 最も大きな散財 | 最も少額の支払い |
    | --- | --- | --- | --- |
    | 15740 | 3148 | 7560 | 0 |

### 6.2.3 検索結果の行数を求める
COUNT関数は、検索結果の行数を教えてくれる集計関数です。この関数には2つの記述方法があります。
- 行数を数える集計関数
    
    ```sql
    COUNT(*)　→ 検索結果の行数
    COUNT(列) → 検索結果の指定列に関する行数
    ```
    
    単純に検索結果の行数を得るには、COUNT(*)という記述が便利です。COUNT関数はあくまでも該当した行数を取得する関数であり、検索結果の値自体が何であるかは問いません。
    
- リスト 6-3 食費の行数を数える
    
    ```sql
    SELECT COUNT(*) AS 食費の行数
      FROM 家計簿
     WHERE 費目 = '食費'
    ```
    
    | 食費の行数 |
    | --- |
    | 1 |
    
    COUNT(*)とCOUNT(列)は、ほぼ同様の動きをしますが、NULLの取り扱いが異なります。
- COUNT(*)とCOUNT(列)の違い
    - COUNT(*)は、単純に行数をカウントする(NULLの行も含める)。
    - COUNT(列)は、指定列の値がNULLである行を無視してカウントする。
- 重複した値を除いた集計
    
    AVG,SUM,COUNTの各関数では、「DISTINCT」を指定することによって、その列で重複している値を除いた状態で集計が行われます。
    
    ```sql
    SELECT COUNT(DISTINCT 費目) FROM 家計簿
    ```
    
    上記のSQL文では、家計簿テーブルに登録されている費目の種類数をカウントすることができます。</details>


<details><summary>6.3 集計に関する4つの注意点</summary>

### 6.3.1 SELECT文でしか利用できない
    
集計関数は、「SELECT文の選択列リスト部分」やORDER BY 句、HAVING 句の中で利用します。WHERE 句の中では利用できません。
    
| SELECT | 列名… ○(記述可能) | FROM テーブル名 × | WHERE ~ × | その他、修飾 △(ORDER BY句またはHAVING句でのみ記述可能) |
| --- | --- | --- | --- | --- |
    
また、「検索結果」に対して集計を行うための道具である集計関数は、UPDATE文、INSERT文、DELETE文で利用することはできません。
    
- 集計関数が記述できる場所
        
集計関数は、SELECT文の選択列リストかORDER BY句、HAVING句にのみ記述できる。
        
### 6.3.2 結果表がデコボコになってはならない
- リスト 6-4 日付と出金額合計を取得するつもりのSELECT文

    ```sql
    SELECT 日付, SUM(出金額) AS 出金額計 FROM 家計簿
    ```

    このSELECT文の結果表が、「日付」と「出金額計」という2つの列を持つことは明らかでしょう。しかし、行数については困ったことになります。

    - 日付の列　　　　→　通常の検索なので、複数行になるはず。
    - 出金額計の列　　→　集計関数の結果なので、1行になるはず。

    列ごとに行数が異なるため、表の形がデコボコになる。しかしデータベースでは、「デコボコ型」の結果表はそもそも認められていません。結果表は、常に列ごとの行数が一致するn行m列の長方形型でなければならないのです。もし結果表がデコボコ型になるようなSQL文を実行すると、実際にはエラーになります。
        
- SQLの結果表
    - 結果表は必ず長方形型になる。
    - 結果表がデコボコになるようなSQL文は実行できない(一部のDBMS製品ではNULLを補うなどして動作するものもあるが、非推奨)。

### 6.3.3 引数に許される型が異なる
    
紹介した5つの集計関数は、いずれも1つの列を引数として受け取り、集計を行います。しかし、引数にどのような方の列を指定できるかは、関数によって異なります。

- 集計関数に渡す引数の型と戻り値

| 関数名 | 数値型 | 文字列型 | 日付型 |
| --- | --- | --- | --- |
| SUM | 各数値の合計 | × | × |
| MAX | 各数値の最大 | 並び替えて最後の文字列 | 最も新しい日付 |
| MIN | 各数値の最小 | 並び替えて最初の文字列 | 最も古い日付 |
| AVG | 各数値の平均 | × | × |
| COUNT | 行数 | 行数 | 行数 |

文字列に対してMAX関数やMIN関数を用いた場合、DBMSが定める照合順序(文字コード順、アルファベット順など)で並べ替え、その最初や最後となる文字列が結果として得られます。
    
### 6.3.4 NULLの取り扱い
    
NULLを含む計算や比較は、基本的に結果もNULLとなることは第3章で紹介しました。しかし、集計関数の場合はそれぞれ取り扱いが異なります。

- 集計関数におけるNULLの取り扱い

| 集計関数 | 集計時のNULLの扱い | 全行がNULLの場合の集計結果 |
| --- | --- | --- |
| SUM | 無視(NULLは集計に影響を与えない) | NULL |
| MAX | 無視(NULLは集計に影響を与えない) | NULL |
| MIN | 無視(NULLは集計に影響を与えない) | NULL |
| AVG | 無視(NULLは集計に影響を与えない) | NULL |
| COUNT 列名指定 | 無視(NULLは集計に影響を与えない) | 0 |
| COUNT * 指定 | NULLを含んでカウントする | 該当行数 |

尚、NULLを0に読み替えて集計をしたい場合は、第5章で紹介したCOALESCE関数を使うと良いでしょう。

- リスト6-5 NULLをゼロとして平均を求める

```sql
/* NULLをゼロに変換した上で平均するサンプル */
SELECT AVG(COALESCE(出金額, 0)) AS 出金額の平均
  FROM 家計簿
```

| 出金額の平均 |
| --- |
| 3148.000000000000000000 |

</details>


<details><summary>6.4 データをグループに分ける</summary>

### 6.4.1 グループ別の集計
集計関数を用いると、検索結果をひとまとまりとして集計し、1つの結果を得ることができました。特に、どんなに多くの行を持つテーブルに対しても、集計を行って得られる結果表は1行になるのが特徴でした。

たとえば、「SELECT SUM(出金額) AS 出金額の合計 FROM 家計簿」というSQL文を使えば、次のような結果が簡単に得られました。

| 出金額の合計 |
| --- |
| 15740 |

しかし、これでは家計簿テーブルのすべての行を合計してしまいます。家計の見直しのためには、次のような「費目別の出金額集計表」を得られれば便利です。どうすればよいのでしょうか？

| 費目 | 費目別の出金額合計 |
| --- | --- |
| 食費 | 380 |
| 給料 | 0 |
| 教養娯楽費 | 2800 |
| 交際費 | 5000 |
| 水道光熱費 | 7560 |

「食費」や「給料」などのここの費目についてWHERE句で絞り込んで集計を繰り返す方法もあります。
- リスト6-6 SQL文をいくつも実行して、各費目の集計結果を得る方法

```sql
SELECT '食費' AS 費目, SUM(出金額) AS 費目別の出金額の合計
  FROM 家計簿
 WHERE 費目 = '食費';   /* ⇒ 「食費」「380」 */

SELECT '給料' AS 費目, SUM(出金額) AS 費目別の出金額の合計
  FROM 家計簿
 WHERE 費目 = '給料';   /* ⇒ 「給料」「0」 */

SELECT '教養娯楽費' AS 費目, SUM(出金額) AS 費目別の出金額の合計
  FROM 家計簿
 WHERE 費目 = '教養娯楽費';   /* ⇒ 「教養娯楽費」「2800」 */
```

- 6.4.2 グループ化


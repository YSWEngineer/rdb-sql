# 第6章 集計とグループ化
第5章では、検索結果のそれぞれの行に対して同じ計算や処理を行える仕組みとして、関数を紹介しました。

この第6章では、検索結果をひとまとめにして集計する方法を学びます。

集計を上手に活用できれば、単にデータを蓄積するだけでなく、蓄積したデータの分析や活用も可能になることを実感してください。

<details><summary>6.1 データを集計する</summary>

### 6.1.1 集計関数とは
集計処理は、次のようなSQL文で簡単に実現できます。
- リスト 6-1 出金額を集計する

```sql
SELECT SUM(出金額) AS 出金額の合計
  FROM 家計簿
```

| 出金額の合計 |
| --- |
| 15740 |

このSQL文で利用されている「SUM」は、検索結果のデータを集計する**集計関数**の1つです。ほかにも、最大値や平均値などを算出する集計関数も存在します。集計関数を使うと、SELECT文による検索結果が集計された形で出力されるようになります。

### 6.1.2 集計関数の特徴
集計関数は、集計の対象となったすべての行に対して1回だけ計算を行い、1つの答えを出します。必然的に、結果表は必ず1行になります。
- **集計関数の特徴**
    - 検索対象の全行をひとまとめに扱い、1回だけ集計処理を行う。
    - 集計関数の結果は、必ず1行になる。</details>


<details><summary>6.2 集計関数の使い方</summary>

### 6.2.1 代表的な集計関数
通常の関数と同様に、DBMS製品によって利用できる集計関数は異なります。しかしほとんどの製品に共通して利用可能なものが、5つの集計関数です。
- 代表的な集計関数

| 分類 | 関数名 | 説明 |
| --- | --- | --- |
| 集計 | SUM | 各行の値の合計を求める |
| 集計 | MAX | 各行の値の最大値を求める |
| 集計 | MIN | 各行の値の最小値を求める |
| 集計 | AVG | 各行の値の平均値を求める |
| 計数 | COUNT | 行数をカウントする |

5つの関数のうち、COUNT関数だけは他の4つと少し特性が異なります。

### 6.2.2 合計、最大、最小、平均を求める
検索結果のある列に対して、合計、最大値、最小値、平均値を求めたい場合、SUM(サム),MAX(マックス),MIN(ミニマム),AVG(アベレージ)関数を利用します。
- 合計、最大値、最小値、平均値を求める集計関数
    
    ```sql
    SUM(列) → 合計
    MAX(列) → 最大値
    MIN(列) → 最小値
    AVG(列) → 平均値
    ```
    
    これらの関数には引数として1つの列名を渡します。また、列名だけではなく「SUM(出金額 * 1.08)」のように、列名を含む式を指定することも可能です。
    
- リスト 6-2 さまざま集計をする
    
    ```sql
    SELECT
        SUM(出金額) AS 合計出金額,
        AVG(出金額) AS 平均出金額,
        MAX(出金額) AS 最も大きな散財,
        MIN(出金額) AS 最も少額の支払い
      FROM 家計簿
    ```
    
    | 合計出金額 | 平均出金額 | 最も大きな散財 | 最も少額の支払い |
    | --- | --- | --- | --- |
    | 15740 | 3148 | 7560 | 0 |

### 6.2.3 検索結果の行数を求める
COUNT関数は、検索結果の行数を教えてくれる集計関数です。この関数には2つの記述方法があります。
- 行数を数える集計関数
    
    ```sql
    COUNT(*)　→ 検索結果の行数
    COUNT(列) → 検索結果の指定列に関する行数
    ```
    
    単純に検索結果の行数を得るには、COUNT(*)という記述が便利です。COUNT関数はあくまでも該当した行数を取得する関数であり、検索結果の値自体が何であるかは問いません。
    
- リスト 6-3 食費の行数を数える
    
    ```sql
    SELECT COUNT(*) AS 食費の行数
      FROM 家計簿
     WHERE 費目 = '食費'
    ```
    
    | 食費の行数 |
    | --- |
    | 1 |
    
    COUNT(*)とCOUNT(列)は、ほぼ同様の動きをしますが、NULLの取り扱いが異なります。
- COUNT(*)とCOUNT(列)の違い
    - COUNT(*)は、単純に行数をカウントする(NULLの行も含める)。
    - COUNT(列)は、指定列の値がNULLである行を無視してカウントする。
- 重複した値を除いた集計
    
    AVG,SUM,COUNTの各関数では、「DISTINCT」を指定することによって、その列で重複している値を除いた状態で集計が行われます。
    
    ```sql
    SELECT COUNT(DISTINCT 費目) FROM 家計簿
    ```
    
    上記のSQL文では、家計簿テーブルに登録されている費目の種類数をカウントすることができます。

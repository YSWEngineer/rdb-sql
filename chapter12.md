# 第12章 テーブルの設計
データ操作やテーブルの作成など、さまざまなSQL文を記述できるようになりました。

しかし、「家計を管理したい」というような具体的な要件を満たすには、どのような構造のテーブルをどのくらい作ればよいのか、頭を悩ませてしまうのではないでしょうか。

この最終章では、要件に応じて適切なテーブル設計を行う手順と方法を学び、SQLとデータベース入門の学習を締めくくりましょう。

<details><summary>12.1 システムとデータベース</summary>

### 12.1.1 システム化と要件
現代の社会生活の至る所で、情報システムは欠かせない存在になっています。システム化によって、かつては人力で行っていた処理をプログラムが行うようになり、紙の帳簿などに記録していたものはコンピュータ上のデータベースに保存するようになりました。

しかし、昔と現代で「まったく変わっていないもの」があります。それは、「お金の入出金を管理したい」という両替商(銀行)の要件(requirements)です。現代社会では、要件の実現手段が「人と紙」から「ATMプログラムとデータベース」に置き換わったにすぎません。

いざ、家計管理データベースを作ろうとしたものの、すぐに壁にぶつかってしまいます。「具体的になにをしたらいいのかわからない」。この段階でデータベースをうまく作れない理由は2つあります。
- **理由1 家計管理の要件を知らない**
    - そもそもどのような家計管理をしたいのか、現在どのように管理しているのかをよく知りません。家計に関するどんな情報を管理すれば要件を満たせるかがわからないため、当然「どのようなテーブルを作ればよいか」も決めることができません。
        
        **先ずは、「データベースを使ってどんな家計管理をしたいか」という要件をしっかり聞き出さなければなりません**。
        
- **理由2 要件をテーブル設計に落とし込む方法を知らない**
    - 要件を聞き出せたとして、その内容は「毎月の入出金の合計を一覧で見られるようにしたい」「システムは夫妻2人で使えるようにしたい」のような曖昧なものでしょう。つまり、要件をただ聞いただけでは「具体的にどんなテーブルを作ればよいか」までは明らかにならないのです。
        
        もちろん要件を意識しながらなんとなくテーブルを作ってみるという方法も考えられますが、しっかりとした根拠のないまま経験や感、度胸で作ったデータベースが、速くて、便利で、安全である確率は極めて低いでしょう。
        
        **聞き出した要件を優れたテーブル設計に確実に変換できる手法や手順を学ばなければならないのです**。
- **データベースを用いたシステムを開発するには**
    
    SQLやDBMSの機能に関する知識だけでは、データベースを用いたシステムは開発できない。要件をしっかりと理解し、その要件をデータベース設計に適切に落とし込むための方法論を活用しなければならない。

### 12.1.2 データベース設計の流れ
システム開発の一環としてデータベースを作ろうとする場合、私たちは何をすればよいのでしょうか。それを明らかにするには、先ず私たちが使える材料(INPUT)と、作るべきもの(OUTPUT)を明確にすることが大切です。

**お客様の用件を訊き**→INPUT→**データベース設計作業**→OUTPUT→**必要なテーブルを持つデータベース**

最初に行うことは用件聴取(インタビュー)です。お客様から用件を聞き出すことは、私たちエンジニアにとって非常に大切な作業です。
インタビューした要件は、後からでも確認しやすいように一覧表にまとめるとよいでしょう。これを材料として、最終的には、必要十分なテーブルを内部に持つデータベースを作ります。
各テーブルは、CREATE TABLE文やCREATE INDEX文などの複数のDDL文を実行すれば作ることができますので、成果物はDDL文と考えてもよいでしょう。
- **データベース構築のINPUTとOUTPUT**
    
    INPUT：要件の一覧表(お客様から聴取したもの)
    
    OUTPUT：一連のDDL文(実行すれば必要十分なテーブルが生成されるもの)
問題は、どのような手順でどのような作業をすれば、このINPUTからOUTPUTを生み出せるかです。これまでもたくさんの先人がさまざまな方法を試してきましたが、その多くに共通するのが次ページ図12-4のような流れです。

先ずは概要をイメージしておきましょう。
- **概念設計**
    - 管理すべき情報はどのようなものなのかを整理します。データベースやシステムに関することは考えず、要件に登場する情報だけをざっくりと把握します。例えば、家計管理データベースであれば、扱うべき情報として「利用者情報」や「入出金情報」などがあることを明確にします。また、情報間で関連がある場合、どのような関係があるかも合わせて整理します。
- **論理設計**
    - 概念設計で明らかになった各情報について、RDBを使う前提で構造を整理し、詳しく具体化していきます。論理設計では「どのようなテーブルを作り、それぞれのテーブルにどのような列を作るか」まで明らかにすれば十分です。型や制約など、付随的な部分については考えません。
- **物理設計**
    - 特定のDBMS製品(例えばOracle DB)をつ使う前提に立ち、論理設計で明らかになった各テーブルについて、その内容を詳しく具体化していきます。全てのテーブルの全ての列について、型、インデックス、制約、デフォルト値など、テーブル作成に必要な全ての要素を確定させます。この物理設計に基づいて、CREATE TABLE文などを含む一連のDDL文を作成し、最終的にデータベース内にテーブルを作成することができます。</details>

<details><summary>12.2 家計管理データベースの要件</summary>

### 12.2.1 立花いずみの要件
お客様にインタビューして、次のような案件を聞き出すことができました。

- 立花いずみの案件
    - 毎日のお金の出入りを記録したい(家計簿の高機能版)。
    - 利用者は家族全員で、それぞれ自分の入出金の行為を記録できるようにしたい。また、現在の家族は2人だが、将来増える可能性も考慮したい。
    - 費目の種類は後から追加できるようにしたい。
    - 費目によって「入金」か「出金」のいずれかが決まっている。
    - 1回の行為で、複数の入出金が発生する場合についても、その明細(費目と入出金の金額)をきちんと分けて記録したい。
    - 例えば、「大家さんに家賃を振り込んだ」場合、次のように記録したい。

| 行為の日付 | 行為の内容 | 費目 | 入出金額 |
| --- | --- | --- | --- |
| 2018-04-10 | 家賃を振り込んだ | 住居日 | 70,000 |
|  |  | 振込手数料 | 525 |

- 1回の行為の中に、同じ費目の明細を複数作ることは許さない。例えば、「住居費」の明細を2つ含む行為は記録できない。
- 将来的にはさまざまな集計をしたいけど、今はいらない。
- 入力時には入力ミスを防ぐ仕組みが欲しい。

### 12.2.2 立花コウジの要件
立花いずみの夫である立花コウジさんから次のような要件をお願いされたようです。
- 「利用者別の費目ごとの合計金額」を集計して、例えば次のように表示したい。

| 利用者名 | 費目名 | 合計金額 |
| --- | --- | --- |
| 立花いずみ | 給与 | 871,900 |
| 立花いずみ | 住居費 | 238,800 |
| 立花コウジ | 給与 | 921,900 |
| 立花コウジ | 住居費 | 238,800 |

- できれば、入出金行為に色々なタグを付けたい。タグの内容は「いいね！」「ムダ遣い！」「反省中」などで、後から追加できるようにしたい。また、タグは、どの利用者が付けたものかをわかるようにし、自分の入出金行為にも、自分以外の入出金行為にも付けることができるようにしたい。
要件を抱えているお客様が複数いる場合は特に注意が必要です。別の相手にインタビューをすると新たな用件が出てきて、概念設計の結果が変わってしまう可能性があるからです。特に他の要件と矛盾する用件が出てきた場合は、お客様同士で話し合い、どのようにするのかを決定してもらわなければなりません。

### 12.2.3 既存の家計管理ノート
夫妻が現在記録している家計管理ノートを材料として仕入れてきました。既に紙などを使って情報を管理している場合、それを入手しておくとテーブル設計の補助資料として活用することができます。</details>


<details><summary>12.3 概念設計</summary>

### 12.3.1 概念設計ですること


# 第3章 操作する行の絞り込み
SQLを用いて思いどおりにデータを操るには、「どの行を対象として、どのように操作するか」をDBMSに的確に伝えなければなりません。

特にWHERE句による対象行の指定は、SQL記述のキーポイントといえるでしょう。

この章では、WHERE句と絞り込み条件に関するさまざまな文法を学びます。

データベースにおけるより高度で複雑な処理が可能になり、SQLがいっそう楽しくなるでしょう。

<details><summary>3.1 WHERE句による絞り込み</summary>

### 3.1.1 WHERE句の大切さ
SQL文の中でWHEREを使うことで、処理対象となる行の絞り込みができます。WHEREキーワードから始まる一連の記述をWHERE句といいます。

SQLを学び始めて間もない頃は、WHERE句のことをSELECTやDELETEのちょっとした付属品のように思いがちです。

- SQLの言語としての特徴
    - 命令自体は単純で、数も少ない(主に使うものは4つ)。
    - しかし、さまざまな修飾語を付けることで、複雑な処理が可能になる。
    
    修飾語のうち最もよく使われるものが、WHERE句です。データを検索、更新、削除など多くの場合、WHERE句を用いて「テーブルのどの行を処理したいのか」を指定します。むしろ、WHERE句が伴わないSQL文を使うことの方が少ないでしょう。なぜなら、テーブル内のすべての行を更新したり削除したりする機会はあまりないからです。
    
    私たちはWHERE句を自由自在に使えてはじめて、データを自由自在に操作することができるのです。


### 3.1.2 WHERE句の基本
WHERE句に関して、3つの基本。
- WHERE句の基本
    1. 処理対象行の絞り込みに用いる→WHEREを指定しないと「すべての行」が処理対象になる。
    2. SELECT、UPDATE、DELETE分で使用可能→INSERT文では使用できない。
    3. WHEREの後ろには条件式を記述する→絞り込み条件に沿った「正しい条件式」を記述する。
    
    1と2については第2章で紹介しました。残る3については、WHERE句の基本構文をしっかり押さえることが大切です。
    
- WHERE句の基本構文
    
    ```sql
    WHERE 条件式
    ```
    
    ただし、WHEREの後ろにはどんな式でも書けるというわけではありません。たとえば、「出金額 < 10000」のような式を記述することができますが、「出金額 + 10000」のような計算式は書くことができません。WHEREの後ろに記述できるのは、条件式と呼ばれる式だけです。</details>


<details><summary>3.2 条件式</summary>

### 3.2.1 真と偽
条件式とは、その結果が必ず真(TRUE)か偽(FALSE)になる式のことです。私たちの日常生活における「YesとNo」のようなものと考えても差し支えありません。

たとえば、「出金額 < 10000」という式は、出金額という列に格納されている値が10000未満の場合は式の意味が正しいので真、10000以上の場合は式の意味が正しくないため偽と判定できます。

では、「出金額 + 10000」という式ではどうでしょうか。

出金額はふつう数字の値です。仮に5000だとすると、「出金額 + 10000」という式の結果も15000という数値になります。結果が数値や文字列、日付などになる式は、WHERE句に記述することはできません。

- WHERE句に書けるもの
    
    結果が必ず真(TRUE)または偽(FALSE)となる条件式


### 3.2.2 WHERE句のしくみ
DBMSがどのようにWHJERE句を処理するか、その仕組みを見てみましょう。

一円以上の出金のあった行をすべて削除するDELETE文

```sql
DELETE FROM 家計簿 WHERE 出金額 > 0
```

**1行ずつ順番に、条件に合うかどうかをチェックするために、「真か偽になる式」しか書いてはいけない。**

WHERE句を含むSQL文を受け取ったDBMSは、テーブル中のすべての行について条件式が真になるかをそれぞれ調べます。そして、真になった行についてのみ、SELECTやUPDATE、DELETEなどの処理を行うのです。</details>


<details><summary>3.3 さまざまな比較演算子</summary>

### 3.3.1 基本的な比較演算子
条件式は、「＝」(等号)や「<」(不等号)のような記号を含んだ式になることがほとんどです。これらの記号は比較演算子といい、その記号の左右にある値を比較して、記号の意味が正しければ真(TRUE)、正しくなければ偽(FALSE)に「化ける」役割を持っています。本書では、SQLの実行によって演算子などが別の値に変化することを「化ける」と表現することにします。

```sql
出金額(3000) > 0 # TRUE
出金額(3000) = 0 # FALSE
```

SQLで利用される比較演算子には他にもたくさんのしゅるいがあります。なかでも次に挙げる6つは最も基本的な比較演算子です。

### 3.3.2 NULLの判定
- NULLとは
    - そこに何も格納されていない、未定義であることを表す。
    - 数字のゼロや空白文字とも異なる。
    
    次の家計簿テーブルは金額がゼロだった箇所がNULLになっています。つまり、0という値すら入っていない空欄の状態になっていることを表しています。
    
    たとえば、入金額が「0」の場合と「NULL」の場合では、意味が異なります。
    
    - 入金額が「0」の場合
        
        2月3日にコーヒー(食費)を購入。380円出金し、0円入金した。
        
    - 入金額が「NULL」の場合
        
        2月3日にコーヒー(食費)を購入。380円出金した。
        
    
    0という値が入金額として記入されているということは、「0円だけれども入金があった」という意味です。一方、NULLとは何もないこと、未定義であることを意味するのですから、入金が発生しなかった、または不明なことを表します。
    
    NULLかどうかを判定するには、=演算子や<>演算子は利用できません。たとえば「SELECT ＊ FROM 家計簿 WHERE 出金額 = NULL」という記述は、正しく判定されません。
    
    列の値がNULLであることを判定するためには`IS NULL 演算子`、NULLでないことを判定するためには`IS NOT NULL 演算子`を使います。
    
- NULLの判定
    - NULLであることを判定する。
    
    ```sql
    式 IS NULL
    ```
    
    - NULLでないことを判定する。
    
    ```sql
    式 IS NOT NULL
    ```
    
    正しいNULLの判定方法
    
    ```sql
    SELECT *
      FROM 家計簿
     WHERE 出金額　IS NULL
    ```
    
    NULLであるかの判定をすべきところに通常の比較演算子を使ってしまうという誤りは、SQLを学び始めて間もない頃によく犯してしまう代表的なミスです。はじめのうちは、意識して注意するようにしましょう。
    
- NULLは＝で判定できない！
    
    NULLは「＝」や「<>」では判定できない。必ずIS NULLやIS NOT NULLを使って条件式を作ること。
    
- 比較演算子の＝でNULLかどうかを判定してはいけない理由—3値論理
    
    ＝などの比較演算子ではNULLの判定ができない理由が気になるという人のために、少し踏み込んで仕組みを紹介しましょう。
    
    この章では、条件式の結果は常に真(TRUE)か偽(FALSE)になると説明しました。しかしSQLの条件式は、これら2つ以外にも、UNKNOWN(不明、計算不能)という3つ目の結果を持つ3値論理と呼ばれる仕組みを採用しています。このUNKNOWNについて、次の2つのことを理解すると、きっと謎が解けるでしょう。
    
    1. ＝や<>などの通常の比較演算子は、もともと値と値を比較するためのもの。よって、「値ではないNULL」を比較すると、不明な結果であるUNKNOWNになる。
    2. WHERE句による絞り込みは、条件式が真(TRUE)となる行だけが選ばれる。条件式が偽(FALSE)やUNKNOWNとなる行は処理対象にならない。

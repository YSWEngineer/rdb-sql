# 第7章 副問い合わせ
SQLには、SQL文の内部に別のSELECT文を記述する、副問い合わせという昨日が備わっています。

この機能を使うことで、1つのSQL文で2つ以上の処理を作成することができます。

また、副問い合わせの構造を理解することは、SQLの作りそのものを理解することにも繋がります。

<details><summary>7.1 検索結果に基づいて表を操作する</summary>

### 7.1.1 2回のSELECTが必要な状況
自分が何に一番お金を使ったのかがすぐにわかるように、「最も大きな出費をしたときの費目と金額」を取得するSQL文を準備しました。- リスト7-1 最も大きな出費の費目と金額を求める

```sql
/* 出金額の最大値を取得して値を書き留めておく */
SELECT MAX(出金額) FROM 家計簿;    -- (1)
/* (1) で得た金額を条件式に記述して費目と金額を取得する */
SELECT 費目, 出金額 FROM 家計簿
 WHERE 出金額 = 【書き留めた額】;    -- (2)
```

もし「最も大きな出費をしたときの費目と金額」を得るためのSQL文を考えるとしたら、どのように組み立てていくでしょうか。

最終的には費目と出金額を知りたいわけですから、まずは「SELECT 費目, 出金額 FROM 家計簿 WHERE…」のように書き始めることでしょう。

しかし、WHERE句の続きを書こうとして、手が止まってしまうはずです。「出金額 = ???」という条件式の右辺に書くべき具体的な値は、実際に家計簿テーブルを調べてみなければわからないからです。そこで仕方なく、その部分を調べるリスト7-1の(1)のSQL文を先に実行するという方法にたどり着くでしょう。

このように「ひとまずSELECT文で何らかの検索結果を得て、得られた具体的な値を用いてさらにSELECTやUPDATEなどを実行する」ことは、データベースを利用する上でよくあることなのです。

### 7.1.2 SELECTをネストする
ひとまずSELECT分で何らかの検索結果を得て、得られた具体的な値を用いてさらにSELECTやUPDATEなどを実行したい場合、それを1つのSQL文で記述することができます。たとえばリスト7-1は、次のように書き換えることができます。
- リスト7-2 1つのSQLで最大の出費に関する費目と金額を求める

```sql
SELECT 費目, 出金額 FROM 家計簿
 WHERE 出金額 = (SELECT MAX(出金額) FROM 家計簿)
```

一般的に、あるものがその内側に別のものを内包している状態を**ネスト構造**や**入れ子**と呼びますが、リスト7-2もSQL文がネスト構造になっています。そして、(1)のSQL文のように、ほかのSQL分の一部分として登場するSELECT文のことを、**副問い合わせ**や**副照会**、または**サブクエリ**と呼びます。

- **副問い合わせとは**
    
    **他のSQL文の一部として登場するSELECT文。丸括弧で括って記述する。**
    

尚、SQLは内部に複数の副問い合わせを持つことや、副問い合わせの中にさらに別の副問い合わせを記述することも可能です。

- **2つの副問い合わせ**

```sql
UPDATE... (SELECT... )
   WHERE... (SELECT... )
```

- **副問い合わせの中に副問い合わせ**

```sql
UPDATE... (SELECT... 
             (SELECT... ))
```

### 7.1.3 副問い合わせを習得するコツ
副問い合わせを使うことによって、複雑で高度なSQL文を書くことが可能になります。書くときは、個々のSQL文を1つずつ作り、あとから組み立ててあげれば良いのです。
- **副問い合わせを習得するコツ**
    - **副問い合わせが処理される仕組みを理解しておく。**
    - **副問い合わせの代表的な3つのパターンを学んでおく。**
これらのコツを意識しておけば、必要に応じて複雑なSQL文を自分の手で組むことが必ずできるようになっていきます。そのためにも、まずは基本をしっかりと押さえておきましょう。

### 7.1.4 コツその1：副問い合わせが処理される仕組み
p206の図7-1が処理されていく家庭を例に取ると、まず副問い合わせのSQL(1)がDBMSによって処理され、具体的な値「7560」に置き換わっています。

副問い合わせを含むSQL文では、まず副問い合わせのSELECT文が実行され、その結果である具体的な値に「化ける」ことになります。その後、化けた値を当てはめて組み立てられた外側のSQL文が実行されていきます。
- **副問い合わせの動作**
    
    まず、内側にあるSELECT文が実行され結果に化ける。そして、外側のSQLが実行される。

### 7.1.5 コツその2：副問い合わせのパターン
副問い合わせで得られる検索結果について、考えてみましょう。副問い合わせの中身はSELECT文なので、得られる結果の形としては、図7-4の3種類が考えられます。
- 単一の値に化ける副問い合わせ

```sql
SELECT... (SELECT... )
↓
SELECT... 15700
```

- 列挙された複数値に化ける副問い合わせ

```sql
SELECT... (SELECT... )
↓
SELECT... 10
          20
          30
```

- 表形式の複数値に化ける副問い合わせ

```sql
SELECT... (SELECT... )
↓
SELECT... X 12  8
          Y  7 12
          Z  4 11
```

### **副問い合わせの3つのパターン**
データベースに限らず、ITの世界では、複数のデータ(値)をある構造に従ってひとかたまりに取り扱うことがよくあります。たとえば、「太陽系の惑星の名前」は、次のように複数の値が並べられた構造になります。

**‘水',’金',’地',’火',’木',’土',’天',’海’**

このように、1つ以上のデータで形成されたものをデータ構造(data structure)といいます。なかでも基本的なデータ構造が次の3つです。
- **スカラー**(単一の値) 例：「昨日の京都の最高気温」、「自分の誕生日」
- **ベクター**(1次元に並んだ値/配列) 例：「過去12ヶ月の京都の最高気温」、「太陽系の惑星の名前」
- **マトリックス**(2次元に並んだ値/表) 例：「過去12ヶ月の各地の最高気温」、「九九の計算結果」

副問い合わせの3つのパターンとは、検索結果がそれぞれスカラー、ベクター、マトリックスになると考えると理解しやすいでしょう。</details>


<details><summary>7.2 単一の値の代わりに副問い合わせを用いる</summary>

### 7.2.1 単一行副問い合わせ
**単一行副問い合わせ**とは、検索結果が1行1列の値となる副問い合わせを指します。この副問い合わせを実行した結果は、1つの値に化けると考えることもできます。

単一行副問い合わせは、単一の値を記述するような場所であれば、基本的にどこでも記述することができます。代表的な場所としては、SELECT文の選択列リストやUPDATEのSET句などが挙げられます。

- 単一行副問い合わせのイメージ

```sql
SELECT... (SELECT...) #結果が1行1列
↓
SELECT... 15700
```

- **単一行副問い合わせとは**
    - 検索結果が1行1列の1つの値となる副問い合わせを指す。
    - SELECT文の選択列リストやFROM句、UPDATEのSET句、また1つの値との判定を行うWHERE句の条件式などに記述することができる。

### 7.2.2 SET句で利用する
- リスト7-3 SET句で副問い合わせを利用する

```sql
UPDATE 家計簿集計
   SET 平均 = (SELECT AVG(出金額)
                FROM 家計簿アーカイブ
               WHERE 出金額 > 0
                 AND 費目 = '食費') # 副問い合わせの結果は5000
WHERE 費目 = '食費'
```

この例では、副問い合わせが「5000」という具体的な数値に変化します。そして最終的には家計簿集計テーブルの平均の列に「5000」をSETするUPDATE文になるというわけです。

副問い合わせを使えば集計と更新が一度にできてしまう。

### 7.2.3 選択列リストで利用する
- リスト7-4 選択リストで副問い合わせを利用する

```sql
SELECT 日付, メモ, 出金額,
       (SELECT 合計 FROM 家計簿集計
         WHERE 費目 = '食費') AS 過去の合計額 # 副問い合わせの結果は 10380
  FROM 家計簿アーカイブ
 WHERE 費目 = '食費'
```

このSQL文の副問い合わせは、家計簿集計テーブルの食費に関する合計学を取得する内容です。集計テーブルの食費に対応する行は1行ですから、検索結果は1つの値になります。

したがって、副問い合わせが10380という具体的な値に変化し、外側のSELECT文は、「食費の各明細と、これまでの食費の合計値を同時に表示する」という動作をします。

※最初から全体を読もうとしても複雑でよくわからないときは、括弧を探すこと。</details>


<details><summary>7.3 複数の値の代わりに副問い合わせを用いる</summary>

### 7.3.1 複数行副問い合わせ
複数行副問い合わせとは、検索結果が複数の行から成る単一列(n行1列)の値となる副問い合わせを指します。したがって、このパターンの副問い合わせを実行した結果は、複数の値に化けるとも考えることができます。

複数行副問い合わせは、SQL文中で「複数の値を列挙」するような場所に、その代わりとして記述することができます。具体的には、IN,ANY,ALL演算子を用いた条件式が代表的な事例です。
- 列挙された複数値に化ける副問い合わせ

```sql
SELECT... (SELECT... ) # 結果がn行1列
↓
SELECT... 10
          20
          30
```

- **複数行副問い合わせとは**
    - 検索結果がn行1列の複数の値となる副問い合わせ(但しnは1以上)。
    - 複数の値との判定を行うWHERE句の条件式や、SELECT文のFROM句に記述することができる。

### 7.3.2 IN演算子で利用する
IN演算子の復習。
- リスト7-5 INを使った条件式の例

```sql
SELECT * FROM 家計簿集計
 WHERE 費目 IN ('食費', '水道光熱費', '教養娯楽費', '給料')
```

- リスト7-6 INで副問い合わせを利用する

```sql
SELECT * FROM 家計簿集計 # 家計簿集計テーブルの全ての列を選択
 WHERE 費目 IN (SELECT DISTINCT 費目 FROM 家計簿) # 副問い合わせの結果は費目のグループ # 
# DISTINCTは重複行を除外する
```

### 7.3.3 ANY/ALL演算子で利用する
- リスト7-7 ANYで副問い合わせを利用する

```sql
SELECT * FROM 家計簿 # 家計簿テーブルから全ての列を選択
 WHERE 費目 = '食費' # 列名費目から文字列「食費」を絞り込む
   AND 出金額 < ANY (SELECT 出金額 FROM 家計簿アーカイブ
                     WHERE 費目 = '食費') # 副問い合わせの結果は食費の金額グループ
```

| 日付 | 費目 | メモ | 入金額 | 出金額 |
| --- | --- | --- | --- | --- |
| 2018-02-03 | 食費 | コーヒーを購入 | 0 | 380 |

**※ANYはたくさんの値を一度に比較したいときに便利。**

ANY演算子は、左辺の値と右辺に列挙された値とを比較して、いずれかの値と併記した比較演算子が成立するかを判定するものでした。この例では「<」演算子をANYと組み合わせていますので、3〜4行目は「**副問い合わせの結果で得られる複数の値のいずれかより出金額が小さければ**」という意味の条件式になります。

もしこのSQL文のANYをALLに書き換えると、「**副問い合わせの結果で得られる複数の値のどれよりも出金額が小さければ**」という条件になります。

### 7.3.4 エラーとなる副問い合わせ
複数行副問い合わせの結果はn行1列、つまり「複数の値」です。よって、IN演算子やANY演算子の「カンマで区切った値の列挙」の代わりに記述することはできても、**単一の値の代わりに記述することはできません**。

たとえば、「SELECT ＊ FROM 家計簿 WHERE 出金額 < 30000」というSQL文の「30000」の部分に、複数行副問い合わせと記述するとエラーになります。副問い合わせの結果得られる複数の値のうち、どれと出金額を比較してよいかわからないからです。

些細な違いですが、不等号の右にANY演算子を加えた、「SELECT * FROM 家計簿 WHERE 出金額 < ANY (30000)」というSQL文であれば、30000の部分に複数行副問い合わせを記述できます。
- **複数行を比較したいときには**
    
    複数行副問い合わせは複数の値に化けるので、単なる等号や不等号では比較できない。等号や不等号にANY/ALL演算子を組み合わせることで、複数の値との比較を行うことができる。
NOT IN 演算子は、右辺に列挙された値のどれとも一致しない場合に真となります。<>ALLも、右辺の全ての値を対象に一致しないことを判定するため、同じく真となります。したがってこの2つは全く同じ働きをするのです。同様に、IN演算子と=ANYも同じ意味になります。
- **同じ意味になる演算子**
    - NOT INと<>ALLは全ての値と一致しないことを判定する演算子。
    - INと=ANYはいずれかの値と一致することを判定する演算子。

### 7.3.5 副問い合わせとNULL
未定義であることを意味するNULLを判定するには、IS NULL演算子かIS NOT NULL演算子を使わなければならないというルールがありました。もし普通の演算子で比較すると、結果は「不明」となり、正しい比較が行えないのです(p083)。

NOT IN 演算子は、右辺に列挙された値を不等号を使って1つひとつ比較し、全ての値と等しくしないことを判定する演算子です。よって、**右辺に1つでもNULLが含まれると、NOT IN演算子による比較結果は全てNULLとなります**。WHERE句は結果が真となる行だけを抽出するので(p078)、最終的にリスト7-8のSELECT文では1行も得られないことになります。
- **副問い合わせがNULLを含んでいた場合**
    
    NOT INまたは<>ALLで判定する副問い合わせの結果にNULLが含まれると、全体の結果もNULLとなる。
    

データにNULLが含まれてしまったために、取得できるはずのデータが取得できないというケースは、データベースを使ったシステムでも陥りやすい落とし穴です。原因を特定することが難しい場合も多いので、特に注意しましょう。

副問い合わせの結果から確実にNULLを除外するには、次ページに挙げた2つの方法があります。

- **副問い合わせの結果から確実にNULLを除外する方法**
    1. 副問い合わせの絞り込み条件に、IS NOT NULL条件を含める。
    2. COALESCE関数を使ってNULLを別の値に置き換える。
- **リスト7-9 副問い合わせからNULLを除外する(IN NOT NULL 版)**

```sql
SELECT * FROM 家計簿アーカイブ
 WHERE 費目 IN (SELECT 費目 FROM 家計簿
                WHERE 費目 IN NOT NULL) # NULLを場外する条件を付加した
```

- **リスト7-10 副問い合わせからNULLを除外する(COALESCE 版)**

```sql
SELECT * FROM 家計簿アーカイブ
 WHERE 費目 IN (SELECT COALESCE(費目, '不明') FROM 家計簿) # 費目がNULLなら代わりに'不明'にする
```

- **行値式と副問い合わせ**
ここではn行1列の検索結果が返る副問い合わせを複数行副問い合わせとしましたが、Oracle DBなどの一部のDBMSでは、結果が複数行複数列でも、複数行副問い合わせとしての利用が可能です。その場合は、複数の列を組み合わせて同時に比較することができます。このような複数の列の組み合わせによる条件式を**行値式**をいいます。

 例) WHERE (A, B) IN (SELECT C, D FROM 〜)</details>


<details><summary>7.4 表の代わりに副問い合わせを用いる</summary>

### 7.4.1 表の結果となる副問い合わせ
表副問い合わせは、副問い合わせの検索結果が複数の行と複数の列からなる表形式(n行m列)の値となる副問い合わせです。したがって、この副問い合わせを実行した結果は、表の形に化けるとも考えることができます。
- **表形式の結果となる副問い合わせとは**
    - 検索結果がn行m列の表となる副問い合わせ(但しn、mは1以上)。
    - SELECT文のFROM句やINSERT文などに記述することができる。

### 7.4.2 FROM句で利用する
- リスト7-11 FROM句で副問い合わせを利用する

```sql
SELECT SUM(SUB.出金額) AS 出金額合計
  FROM (SELECT 日付, 費目, 出金額
          FROM 家計簿
        UNION
        SELECT 日付, 費目, 出金額
          FROM 家計簿アーカイブ
         WHERE 日付 >= '2018-01-01'
           AND 日付 <= '2018-01-31') AS SUB # FROM句はすべて副問い合わせ
```

副問い合わせに「SUB」という別名が付けられています。その別名を利用して、外側のSELECTの選択列リストでは、抽出対象とする副問い合わせとその項目を明示しています。

**※別名を付けることでSQL文がわかりやすくなり、DBMSも解析がしやすくなって実行速度が上がることもある。**

### 副問い合わせに別名をつけるときの注意点
別名の表記方法も、DBMS製品によって異なるので、利用する環境に応じて対応してください。

### 7.4.3 INSERT文で利用する
そもそもINSERT文は、基本的に、1回の呼び出しで1行しか追加できません。つまり、単純に考えると100行分のデータを追加したい場合は、100回のINSERT文を実行する必要があります。

しかし、**副問い合わせを使えば1回のINSERT文で複数行のデータを登録することが可能**になります。
- リスト7-12 INSERT文で副問い合わせを利用する

```sql
INSERT INTO 家計簿集計(費目, 合計, 平均, 回数)
SELECT 費目, SUM(出金額), AVG(出金額), 0 # 集計結果を表形式で返す副問い合わせ
  FROM 家計簿
 WHERE 出金額 > 0
 GROUP BY 費目 
```

2行目以降、最後までが副問い合わせです。今までと異なり今回の副問い合わせは、括弧で括られていません。このパターンだけの特例なので慣れてしまいましょう(厳密にはINSERT文の特殊構文です)。

今回の副問い合わせは、INSERT文の**VALUES以降の記述に相当する内容に化けるもの**です。SELECTの検索結果がそのままテーブルに登録すべき値として処理されます。

### 単独で処理できない副問い合わせ
副問い合わせは自信を取り囲む外側のSQL文(主問い合わせ)から独立していることが一般的です。しかし、次のような少し特殊な副問い合わせが利用されることがあります。

```sql
/* 今月使った費目(家計簿テーブルに登場する費目)についてのみ、
   合計金額を家計簿集計テーブルから抽出したい */
SELECT 費目, 合計 FROM 家計簿集計
 WHERE EXISTS
(SELECT * FROM 家計簿 WHERE 家計簿.費目 = 家計簿集計.費目)
```

このように、副問い合わせの内部から主問い合わせの表や列を利用する副問い合わせを、相関副問い合わせといいます。

特に上記のように、「ほかのテーブルに値が登場する行のみ抽出したい」場合に、EXISTS演算子とともに使われます。この形態は典型的な活用例ですので、パターンとして覚えておくとよいでしょう。

```sql
SELECT 列 FROM テーブル1
 WHERE EXISTS
(SELECT * FROM テーブル2 WHERE テーブル1.列 = テーブル2.列)
```

相関副問い合わせは副問い合わせの一種ではありますが、その処理方法や動作原理は一般的な副問い合わせと根本的に異なるため、全くの別物として理解することをお勧めします。

通常の副問い合わせが「内側の副問い合わせを1回処理→主問い合わせを1回処理」という単純な手順であるのに対して、相関副問い合わせは「外側SQLでテーブルから行を絞り込む過程で、各行について抽出してよいかを判断するために、繰り返し副問い合わせを実行する」ため、DBMSの負荷は大幅に増加します。</details>


<details><summary>7.5 この章のまとめ</summary>

### 7.5.1 この章で学習した内容
- **SQLのネスト**
    - SQL文の中に別のSELECT文を記述することができ、これを副問い合わせや副照会、またはサブクエリという。
    - 副問い合わせは、実行すると何らかの値に置き換わる。
    - 副問い合わせは、より内側にあるものから外側に向かって順に評価されていく。
- **副問い合わせのパターン**
    - 副問い合わせの結果が1行1列になるものを単一行副問い合わせという。
    - 副問い合わせの結果がn行1列になるものを複数行副問い合わせという。
    - 結果がn行m列の表形式になる副問い合わせも利用される。
- **複数行副問い合わせと演算子**
    - 複数行副問い合わせは、IN、ANY、ALL演算子と併せてよく用いられる。
    - 複数行副問い合わせの結果にNULLが含まれると、NOT IN、<>ALL演算子の評価結果もNULLとなる。

### 7.5.2 この章でできるようになったこと
- 食費の合計額を集計して集計テーブルを更新したい！

```sql
UPDATE 家計簿集計
   SET 合計 = (SELECT SUM(出金額)
                 FROM 家計簿アーカイブ
                WHERE 出金額 > 0
                  AND 費目 = '食費')
 WHERE 費目 = '食費';
```

- 1月と12月の出金額の合計をそれぞれ知りたい。

```sql
SELECT SUMLIST.タイトル, SUMLIST.出金額計
  FROM (SELECT '合計01月' AS タイトル, SUM(出金額) AS 出金額計
          FROM 家計簿アーカイブ
         WHERE 日付 >= '2022-01-01'
           AND 日付 <= '2022-01-31'
         UNION
        SELECT '合計12月' AS タイトル, SUM(出金額) AS 出金額計
          FROM 家計簿アーカイブ
         WHERE 日付 >= '2021-12-01'
           AND 日付 <= '2021-12-31') AS SUMLIST;
```

- 今月初めて発生した費目を知りたい。

```sql
SELECT DISTINCT 費目 FROM 家計簿
 WHERE 費目 NOT IN (SELECT 費目 FROM 家計簿アーカイブ);
```

- 今月の給料で先月までよりも高い額があれば知りたい…。

```sql
SELECT * FROM 家計簿
 WHERE 費目 = '給料'
   AND 入金額 > ALL (SELECT 入金額 FROM 家計簿アーカイブ
                     WHERE 費目 = '給料');
```

- 今月の家計簿データをアーカイブしたい！

```sql
INSERT INTO 家計簿アーカイブ
SELECT * FROM 家計簿;
```

- **パターンにとらわれずに自由に副問い合わせを使おう**

### パターンにとらわれずに自由に副問い合わせを使おう
今回紹介したものだけが、副問い合わせを記述可能な場所の全てというわけではありません。

詳細はDBMS製品によって異なりますが、SQL文の中で単一の値を記述できる場所は、たいてい、単一行副問い合わせに置き換えることができます。複数の値の列挙が求められる場所には、複数行副問い合わせを書いてみれば動くこともあるでしょう。

「副問い合わせがどのような形に化けるか」についての意識さえできていれば、さまざまな場所で自由に副問い合わせを活用できるようになるはずです。</details>

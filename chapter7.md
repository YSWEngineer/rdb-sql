# 第7章 副問い合わせ
SQLには、SQL文の内部に別のSELECT文を記述する、副問い合わせという昨日が備わっています。

この機能を使うことで、1つのSQL文で2つ以上の処理を作成することができます。

また、副問い合わせの構造を理解することは、SQLの作りそのものを理解することにも繋がります。

<details><summary>7.1 検索結果に基づいて表を操作する</summary>

### 7.1.1 2回のSELECTが必要な状況
自分が何に一番お金を使ったのかがすぐにわかるように、「最も大きな出費をしたときの費目と金額」を取得するSQL文を準備しました。- リスト7-1 最も大きな出費の費目と金額を求める

```sql
/* 出金額の最大値を取得して値を書き留めておく */
SELECT MAX(出金額) FROM 家計簿;    -- (1)
/* (1) で得た金額を条件式に記述して費目と金額を取得する */
SELECT 費目, 出金額 FROM 家計簿
 WHERE 出金額 = 【書き留めた額】;    -- (2)
```

もし「最も大きな出費をしたときの費目と金額」を得るためのSQL文を考えるとしたら、どのように組み立てていくでしょうか。

最終的には費目と出金額を知りたいわけですから、まずは「SELECT 費目, 出金額 FROM 家計簿 WHERE…」のように書き始めることでしょう。

しかし、WHERE句の続きを書こうとして、手が止まってしまうはずです。「出金額 = ???」という条件式の右辺に書くべき具体的な値は、実際に家計簿テーブルを調べてみなければわからないからです。そこで仕方なく、その部分を調べるリスト7-1の(1)のSQL文を先に実行するという方法にたどり着くでしょう。

このように「ひとまずSELECT文で何らかの検索結果を得て、得られた具体的な値を用いてさらにSELECTやUPDATEなどを実行する」ことは、データベースを利用する上でよくあることなのです。

### 7.1.2 SELECTをネストする
ひとまずSELECT分で何らかの検索結果を得て、得られた具体的な値を用いてさらにSELECTやUPDATEなどを実行したい場合、それを1つのSQL文で記述することができます。たとえばリスト7-1は、次のように書き換えることができます。
- リスト7-2 1つのSQLで最大の出費に関する費目と金額を求める

```sql
SELECT 費目, 出金額 FROM 家計簿
 WHERE 出金額 = (SELECT MAX(出金額) FROM 家計簿)
```

一般的に、あるものがその内側に別のものを内包している状態を**ネスト構造**や**入れ子**と呼びますが、リスト7-2もSQL文がネスト構造になっています。そして、(1)のSQL文のように、ほかのSQL分の一部分として登場するSELECT文のことを、**副問い合わせ**や**副照会**、または**サブクエリ**と呼びます。

- **副問い合わせとは**
    
    **他のSQL文の一部として登場するSELECT文。丸括弧で括って記述する。**
    

尚、SQLは内部に複数の副問い合わせを持つことや、副問い合わせの中にさらに別の副問い合わせを記述することも可能です。

- **2つの副問い合わせ**

```sql
UPDATE... (SELECT... )
   WHERE... (SELECT... )
```

- **副問い合わせの中に副問い合わせ**

```sql
UPDATE... (SELECT... 
             (SELECT... ))
```

### 7.1.3 副問い合わせを習得するコツ

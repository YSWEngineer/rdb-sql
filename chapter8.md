# 第8章 複数テーブルの結合
SQLのさまざまな機能や構文について学んできましたが、その殆どは、単一のテーブルに対するものでした。

さらにデータベースの実力を最大限に引き出すためには、複数テーブルに分けて格納されたデータを同時に取り出す「結合」の活用が欠かせません。

本格的な家計簿データベースの実現に向け、複数テーブルの取り扱い方を学びましょう。

<details><summary>8.1 「リレーショナル」の意味</summary>

### 8.1.1 RDBMSの真の実力
- **これまで学んだこと**
    
    **第Ⅰ部 データの格納と取り出しについて**
    
    - 4代命令でテーブルにデータを出し入れできる(第2章)。
    - WHERE句で処理対象行を絞り込める(第3章)。
    - ORDER BYやDISTINCTで検索結果に追加の処理を施せる(第4章)。
    
    **第Ⅱ部 データの取得と同時に計算や処理をさせる方法**
    
    - 式や関数を用いて、計算や集計をさせることができる(第5、6章)。
    - 一度行った検索結果を用いて、データを操作できる(第7章)。
    
    これらは**データベースの機能のうち特に学びやすい一部だけを選んだ**ものです。つまり、データベースに真の実力を発揮させるための機能や構文は、まだ紹介していません。
    
- **データベースの優位性**
    
    データを安全、確実、高速に取り扱うために生まれたデータベースは、表計算ソフトにはないさまざまな機能を備えている。

### 8.1.2 複数テーブルへのデータ格納
新しい家計簿テーブルでは、費目列が費目ID列になり、その内容がただの数字になっています。この数字は「費目テーブル(テーブル8-3)におけるIDが2の行(つまり、食費の行)」を指し示しています。

### 8.1.3 外部キーとリレーションシップ
「ID」列は費目テーブルの主キーなので重複はありえません。そのためIDの値が決まればどの行を意味するかが確定します。つまり、家計簿テーブルの各行では、費目IDを指定してあげることで、費目テーブルのどの1行を指し示すかを明確に指定することができるのです。

家計簿テーブルからは費目の名前は消えてしまいましたが、費目テーブルのIDを辿ることで費目の名前がわかるようになっているのです。

「家計簿テーブル」と「費目テーブル」のように、ある2つのテーブルの行に情報としての関連がある場合、その関連を**リレーションシップ**(relationship)といいます。

また、家計簿テーブルの「費目ID」列のように、ほかのテーブルの関連行を指すための値を格納することでリレーションシップを結ぶ役割を担っている列のことを**外部キー**(foreign key)といいます。
- **外部キー列の役割**
    
    外部キー列は、他テーブルのある列(主キー列など)の値を格納することによって、「その行が他テーブルのどの行と関連しているか」を明らかにする。

### 8.1.4 複数テーブルに分けるメリット
コンピュータにとっては、テーブルが分割されていた方がデータを安全、確実、高速に取り扱いやすいのです。具体的にわかりやすい例をいくつか挙げてみましょう。
- **例1 費目の名前を変更する場合**
    
    家計簿テーブルに10万行のデータが既に格納された状態で、「給料」という名前だった費目を「給与手当」に変更することにしましょう。もしテーブル8-1にある古い家計簿テーブルだとしたら、リスト8-1のようなSQL文を実行することになります。
    
    - リスト8-1 古い家計簿テーブル(テーブル8-1)の場合
    
    ```sql
    UPDATE 家計簿
       SET 費目 = '給与手当'
     WHERE 費目 = '給料'
    ```
    
    このSQL文を実行すると、DBMSは家計簿テーブルに格納された10万行全てに対して、1行ずつ条件に合致するかを調べて書き換えることになります。
    
    一方、もしテーブルがp239のテーブル8-2と8-3のように分割されていた場合はリスト8-2のようなSQL文になります。
    
    - リスト8-2 新しい家計簿テーブル(テーブル8-2、テーブル8-3)の場合
    
    ```sql
    UPDATE 費目
       SET 名前 = '給与手当'
     WHERE 名前 = '給料'
    ```
    
    このSQL文はリスト8-1ととてもよく似ていますが、DBMSが処理対象とする行数には明らかな違いがあります。費目の種類は多く見積もっても100個程度と考えられるため、DBMSは100行程度しかない費目テーブルを調べ、条件に合致するたった1行を書き換えるだけの仕事で済むのです。
    
- **例2 費目に関する補足情報を管理したい場合**
    
    テーブル8-3の費目テーブルでは各費目についての解説文を「備考」列として管理しています。これにより、例えば将来、収支区分などの列を加えていくことも容易になります。
    
    もし家計簿テーブルだけを単独で使い、費目に関して名前以外の情報も同じ家計簿テーブルに格納しようとすると、次のテーブル8-4のように**内容に重複が多く、わかりにくい表になってしまうのです**。
    
- **例3 ある特定行の費目名を書き換える場合**
    - リスト8-3 矛盾した状態を生むテーブル更新
    
    ```sql
    UPDATE 家計簿
       SET 費目 = '雑収入', メモ = '宝くじに当たった'
     WHERE 日付 = '2018-02-10'
    ```
    
    リスト8-3を実行すると、テーブル8-4の費目列の内容は「雑収入」に更新されますが、「費目の備考」列の更新を忘れてしまっています。費目は「雑収入」なのに備考は「給与や賞与が入った」という、矛盾した状態になってしまうのです。
    
    同じような情報をいろいろな場所で数多く保存していると、そのうちの1つだけを更新したり参照したりしたい場合であっても、分散している同じ種類のデータ全てについて、漏らすことなく検索して拾い上げなければなりません。
    
    3つの例が示すように、1つのテーブルにさまざまな情報を詰め込むことは、データの管理を難しくします。複数のテーブルにわけてデータを管理する方が、管理には適しているのです。
    
- **複数のテーブルに分けるメリット**
    
    データを複数のテーブルにわけて格納したほうが、安全、確実にデータを管理しやすい。

### 8.1.5 デメリットの克服
複数のテーブルにわけてデータを格納したほうが、管理に適していることは事実です。一方で、費目を番号で管理する家計簿テーブルには「人間にとって理解しにくい」というデメリットがあることに変わりありません。

しかし、データベースの多くは、「**管理に適した形態の複数テーブルから、人間が理解しやすい形態の1つの結果票を得る**」ための**結合**(join)という機能を備えています。

結合の他にも、私たちが普段利用する多くのデータベース製品は、複数のテーブルにわけて格納されたデータを関連づけて管理、利用するためのさまざまな機能を有しています。このようなデータベースを**リレーショナルデータベース**(RDB:Relational Database)といい、その中枢を担うDBMSをRDBMSといいます。
- **リレーショナルデータベース(RDB)**
    
    RDBは、データを複数テーブルで安全、確実に管理しながら、必要に応じて「人間にわかりやすい表」に結合することができる。
    

※データは、管理しやすいように複数テーブルに格納して、人に見せるときだけ結合すれば良い。</details>


<details><summary>8.2 テーブルの結合</summary>

### 8.2.1 結合の基本的な使い方
結合を行うために、SELECT文には次のような構文が用意されています。
- **テーブルAとテーブルBの結合**
    
    ```sql
    SELECT 選択列リスト
      FROM テーブルA
      JOIN テーブルB
        ON 両テーブルの結合条件
    # 選択列リストには両テーブルの列を指定可能。
    ```
    
    たとえば、家計簿テーブルに費目テーブルの内容を結合するような処理を実現するには、リスト8-4のようなSELECT文を記述します。
    
    - リスト8-4 図8-3の結合を実現するためのSELECT文
    
    ```sql
    SELECT 日付, 名前 AS 費目, メモ 
      FROM 家計簿
      JOIN 費目 # 結合するほかの表を指定 # (家計簿テーブルに)費目テーブルを加えろ
        ON 家計簿.費目ID = 費目.ID # 結合条件を指定 # 家計簿テーブルの費目ID列と費目テーブルのID列を紐付けろ
    ```
    
    1行目と2行目で、家計簿テーブルを検索して「日付」「名前(列名は別名として費目と表示する)」「メモ」の3つの列からなる結果表を出力することを指示しています。注目してほしいのは、1行目で指定している列のうち「名前」という列だけは、家計簿テーブルには存在しないということです。通常、テーブルに存在しない列をSELECT文の選択列リストに記述するとエラーになってしまいます。
    
    今回のSQL文がエラーにならないのは、3行目の**JOIN句**によって家計簿テーブルに費目テーブルが結合され、「ID」「名前」という列も参照可能になるからです。DBMSは**まず2つのテーブルを結合した上で、列の絞り込み(選択列リストの指示による)や、行の絞り込み(WHERE句の指定による)を行っていきます**。
    
    また、家計簿テーブルの各行に、費目テーブルのどの行を繋ぐかは4行目のON句の結合条件で指定しています。今回の「家計簿.費目ID = 費目.ID」という条件式は、次の指示をしていることになります。
    
    - 家計簿テーブルの各行について、まず費目ID列のデータに注目しなさい。
    - それと等しいIDを持つ費目テーブルの行を取り出して繋ぎなさい。
- 8.2.2 結合の動作イメージ
    
    結合は、入門者が最も躓きやすいポイントです。初めのうちは、その動作を理解することが難しいかもしれません。**DBMSがどのように結合処理をしていくか、頭の中にしっかりイメージを描き、定着させることが上達の近道**です。
    
    そもそも結合とは、2つのテーブルを単純にくっつけるような処理ではありません。
    
    また、**結合に関係する2つのテーブルは対等な関係ではありません**。あくまでも**FROM句で指定したテーブルが主役**であり、それに**JOIN句で指定したテーブルの内容を必要に応じて繋いで**いきます。
    
    たとえばリスト8-4の場合、DBMSは家計簿テーブルを1行ずつ処理していきながら、「この行に繋ぐべき、費目テーブルの行はどれか？」と探しながら、行と行を繋いでいくのです。
    
    **※DBMSは1行ずつ「どの行を右に繋ぐべきか」を探しながら結合する。**
    
    より具体的には、DBMSは左表の各行について、相手となる行を探すために次のようなSQL文を繰り返し実行しています。
    
    - リスト8-5 結合の際にDBMSが内部で繰り返し実行している処理
    
    ```sql
    -- 次のSQLの結果得られた行を、現在注目している左表の行に繋ぐ
    SELECT * FROM 右表 WHERE 結合条件の式
    ```
    
    - **結合とは**
        
        結合とは、テーブルを丸ごと繋ぐことではなく、結合条件が満たされた行を1つひとつ繋ぐことである。</details>



<details><summary>8.3 結合条件の取り扱い</summary>

### 8.3.1 結合相手が複数行の場合
もし何らかの理由で費目テーブルのID列に重複する値が入っていた場合はどうなるでしょうか。

図8-9の場合、2月10日の給料の行についてDBMSは次のようなSQLを内部で発行します。

```sql
SELECT * FROM 費目 WHERE 1 = 費目.ID
```

この結果得られる繋ぐべき行として、「給料」「仕送り」の2つの行が見つかってしまいます。1つの行に2つの行を結合することは物理的に不可能です。そのような場合、DBMSは右表の行数に合わせて左表の行を複製して結合させます。**左表に対して重複がある列を相手とした結合を行うと、結合前より行数が増える**ことになります。
- **右表の結合条件列の重複**
    
    繋ぐべき右表の行が複数あるとき、DBMSは左表の行を複製して結合する。結果表の行数は、もとの左表の行数より増える。

### 8.3.2 結合相手の行がない場合
逆に、結合によって結果表の行数が減ってしまうケースを紹介します。

```sql
SELECT * FROM 費目 WHERE 4 = 費目.ID
```

左表の費目ID列の値「4」に相当する費目テーブルのIDが存在しないため、繋ぐべき右表の行を見つけることができません。このような場合、DBMSはこの行の結合自体を諦め、次の行の処理に進みます。そのため、もともと左表になった2月5日の行は結合結果からは消滅してしまいます。

**※結合相手がいない左表の行は、結果表に出力されない。**

NULLはほかのどのような値と比較しても等しくならない存在です。もちろん、NULLとNULLを等しいかを比較しても、真にはなりません。

そのため、結合の際にDBMSが内部で発行する次のようなSQLも、結果は常に0行です。

```sql
SELECT * FROM 費目 WHERE NULL = 費目.ID
```

このような場合も、もともと左表にあった行は結合結果から消滅し、結果表に現れることはありません。
- **結合相手のない結合**
    
    右表に結合相手の行がない場合や、左表の結合条件の列がNULLの場合、結合結果から消滅する。

### 8.3.3 左外部結合
DBMSに対して「左表については結合相手が見つからなくも、NULLであっても必ず出力せよ」という左外部結合(left outer join)指示をすることができます。具体的には、今までSQL文中で「JOIN」と記述していた部分を、「LEFT JOIN」とするだけです。
- **左外部結合**
    
    ```sql
    SELECT 〜 FROM 左表の名前
         LEFT JOIN 右表の名前
                ON 結合条件
    # LEFT JOINは、LEFT OUTER JOINと記述してもよい
    # 結合相手の行がない場合や左表の結合条件列がNULLの場合、選択列リストに抽出される右表の列はすべてNULLとなる
    ```
    
    左外部結合の指示があると、右表に結合相手の行が存在しない場合でも、あるいは左表の行がNULLであっても、DBMSは結合を諦めません。右表の中に結合すべき行がない場合、**全ての値がNULLである行を新たに生み出して結合して**くれます。結果的に、左表の行が結合によって失われることはなくなります。

### 8.3.4 RIGHT JOIN とFULL JOIN
右外部結合(right outer join)や完全外部結合(full outer join)も存在します。
- **その他の外部結合**
    - 右外部結合：右表の全行を必ず出力する
    
    ```sql
    SELECT ~ FROM 左表の名前
       RIGHT JOIN 右表の名前
               ON 結合条件
    ```
    
    - 完全外部結合：左右の表の全行を必ず出力する
    
    ```sql
    SELECT ~ FROM 左表の名前
        FULL JOIN 右表の名前
               ON 結合条件
    # RIGHT JOINやFULL JOINは、RIGHT OUTER JOINやFULL OUTER JOINと記述してもよい。
    ```
    
    たとえば、右外部結合を使えば右表の全ての行が必ず結果表に出力されます。もし左表で使われていない費目が右表にあった場合も、その行の情報が失われることはありません。
    
    左外部結合、右外部結合、完全外部結合は、いずれも本来結果表から消滅してしまう行も強制的に出力する効果があります。これらを総称して**外部結合**(outer join)といいます。対して、結合すべき相手の行が見つからない場合に行が消滅してしまう通常の結合は、**内部結合**(inner join)といいます。

### FULL JOINをUNIONで代用する
MySQLやMariaDBなど、FULL JOINを利用できないDBMSでは、集合演算子UNIONを使って同等の処理を実現することができます。

```sql
    SELECT 選択列リスト FROM 左表の名前
 LEFT JOIN 右表の名前
        ON 左表の結合条件列 = 右表の結合条件列
     UNION
    SELECT 選択列リスト FROM 左表の名前
RIGHT JOIN 右表の名前
        ON 左表の結合条件列 = 右表の結合条件列
```

LEFT JOINによって左表の全ての行を出力した結果と、RIGHT JOINによって右表の全ての行を出力した結果を、UNIONによって足し合わせるというSQL文です。これは、**FULL JOINによって左右の表の全行を取り出すことと同じ意味**となります。</details>


<details><summary>8.4 結合に関するさまざまな構文</summary>

### 8.4.1 テーブル名の指定
2つのテーブルを結合すると、同じ名称の列が複数登場する場合があります。

このような場合、列名指定の前に「テーブル名.」という表記を加え、どのテーブルに属する列であるかを明示的に指定することができます。
 - リスト8-6 2種類のメモを両方出力するSQL文

```sql
SELECT 日付, 家計簿.メモ, 費目.メモ # 属するテーブル名を明示 # 日付、家計簿テーブルのメモ列、費目テーブルのメモ列を選択
  FROM 家計簿 # 家計簿テーブルから
  JOIN 費目 # (家計簿テーブルに)費目テーブルを加える
    ON 家計簿.費目ID = 費目.ID # 家計簿テーブルの費目ID列に費目テーブルのID列を紐付けせよ
```

なお、テーブル名が長く複雑な場合、リスト8-7のようにASで別名をつけておくと列指定や結合条件の記述が簡潔になります。

- リスト8-7 別名を使ったSQL文

```sql
SELECT 日付, K.メモ, H.メモ
  FROM 家計簿 AS K -- 家計簿テーブルに別名Kを設定
  JOIN 費目 AS H -- 費目テーブルに別名Hを設定
    ON K.費目ID = H.ID
```

### 8.4.2 3テーブル以上の結合
「JOIN ~ ON ~」を繰り返すことで、3つ以上のテーブルを結合することもできます。この場合も一度に3つのテーブルが結合されるわけではなく、前から順に1つずつ結合処理が行われていきます。

- リスト8-8 3つのテーブルを結合するSQL文

```sql
SELECT 日付, 費目.名前, 経費区分.名称
  FROM 家計簿   -- 家計簿テーブルに対して…
  JOIN 費目     -- まず費目を結合して…
    ON 家計簿.費目ID = 費目.ID
  JOIN 経費区分  -- その結果にさらに経費区分を結合
    ON 費目.経費区分ID = 経費区分.ID
```

### 8.4.3 副問い合わせの結果との結合
JOIN句のすぐ後ろに記述できるのは、テーブルだけでなく、「表形式のデータに化ける副問い合わせ」も記述することができます。

副問い合わせの結果がテーブルの代わりとして利用されることを除けば、通常の結合と違いはありません。但し、選択列リストや結合条件の指定のために、副問い合わせに別名を指定することが必要になります。

- リスト8-9 副問い合わせの結果と結合するSQL文

```sql
SELECT 日付, 費目.名前, 費目.経費区分ID
  FROM 家計簿 -- 家計簿テーブルに対して……
  JOIN ( SELECT * FROM 費目
         WHERE 経費区分ID = 1
       ) AS 費目 -- 副問い合わせの結果を結合
    ON 家計簿.費目ID = 費目.ID
```

### 8.4.4 同じテーブル同士を結合結合は異なるテーブル間で行われることが一般的ですが、自分自身と結合させることも可能です。同一テーブル同士を結合することを**自己結合**(self join)や**再帰結合**(recursive join)といいます。

- リスト8-10 自分自身と結合するSQL文

```sql
   SELECT A.日付, A.メモ, A.関連日付, B.メモ
     FROM 家計簿 AS A
LEFT JOIN 家計簿 AS B
       ON A.関連日付 = B.日付
```

尚、自己結合を行う場合、選択列リストや条件式を記述するために、**同じテーブルに別の名前を付ける**ことになります。

### イコール以外の結合条件式
結合の条件には等価記号(=)を用いた結合条件を指定することがほとんどです。しかし原理的には、=以外の演算子を用いた条件式も記述することができます。

```sql
SELECT ~ FROM テーブルA
  JOIN テーブルB ON テーブルA.列名 < テーブルB.列名
```

このような結合を**非等価結合**(non-equi join)といいます。動作の仕組みは通常の結合と同じですが、DBMSにかかる負荷が大きなものとなる点には注意してください。</details>


<details><summary>8.5 この章のまとめ</summary>

### 8.5.1 この章で学習した内容
- **リレーションシップ**
    - 本格的にデータベースを活用する場合、データは複数のテーブルに分けて格納する。
    - 他のテーブルのある行と関連づけるために、外部キーを利用してリレーションシップを構成する。
    - 外部キーとは、関連する他テーブルのある列(主キー列など)の値を記述したものである。
- **結合**
    - 結合を用いることで、複数のテーブルに格納された関連するデータを1つの結果表として取り出すことができる。
    - 結合を行う相手テーブルを指定するためにJOIN句を、結合条件を指定するためにON句を記述する。
    - 外部結合を用いると、結合相手がない行も結果表に出力させることができる。
- **結合構文のバリエーション**
    - 3テーブル以上の結合も、順に1つずつ処理される。
    - 副問い合わせの結果表と結合することもできる。
    - 自分自身のテーブルと結合することができる。

### 8.5.2 この章でできるようになったこと
- 家計簿テーブルと費目テーブルを結合して、費目を日本語で表示したい！

```sql
SELECT 日付, 名前 AS 費目, メモ, 入金額, 出金額
  FROM 家計簿
  JOIN 費目
    ON 家計簿.費目ID = 費目.ID;
```

- 家計簿テーブルの費目IDが定義されていない行も結果表に出力されるように結合したい。

```sql
SELECT 日付, 名前 AS 費目, メモ, 入金額, 出金額
  FROM 家計簿
  LEFT JOIN 費目
         ON 家計簿.費目ID = 費目.ID;
```

- 「給料」という名前の費目に関する、家計簿テーブルの行を見たい。

```sql
SELECT 家計簿.* FROM 家計簿
  JOIN (SELECT * FROM 費目 WHERE 名前 = '給料') AS 費目
    ON 家計簿.費目ID = 費目.ID
```

</details>

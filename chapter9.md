# 第9章 トランザクション
第Ⅱ部までDBMSでデータを操作するためのさまざまなSQLの構文を学んできました。

しかし、DBMSにSQL文を送っても、常に正しくデータ操作が完了するとは限りません。

処理中に突然コンピュータの電源が落ちてしまうかもしれませんし、他の人が書き換え途中のデータを読み込んでしまうかもしれません。

この章では、そのような思いがけない事態に備え、安全で確実なデータ操作を実現するDBMSの機能について紹介します。

<details><summary>9.1 正確なデータ操作</summary>

### 9.1.1 正確なデータ操作を脅かすもの
**安全で確実なデータ操作とデータ管理ほど重要なことはありません。**

DBMSはSQL文の指示通りに正確な処理を実行してくれます。理論的には、データベースないに誤ったデータを格納することはできないと感じるかもしれません。しかし現実には、DBMSが正しく処理を完了できなかったり、テーブル内のデータがおかしな値になってしまったりする可能性があります。

たとえば、急にコンピュータの電源が落ちて、一連のSQLの処理が中途半端なところで中断してしまうかもしれません。また、読み書きしかけていたデータを他人が横から書き換えてしまう可能性もあります。

### 9.1.2 トランザクション
①予期しない処理中断、②同時操作の2つのケースは、金融機関の基幹システムのように極めて重要なシステムでも発生する可能性があります。しかし、「停電があったのでデータベースが壊れ、残高がおかしくなりました」という言い訳は許されません。

そこで、DBMSにはこのような問題が起きないようにするための仕組みが備わっています。

実は私たちがDBMSに対して複数のSQL文を送る際、1つ以上のSQL文をひとかたまりとして扱うよう指示することができます。このかたまりのことを**トランザクション**(transaction)といいます。

DBMSはトランザクションを次のように扱います。
- **DBMSによるトランザクションの制御**
    - トランザクションの途中で、処理が中断されないようにする。
    - トランザクションの途中に、他の人の処理が割り込めないようにする。

DBMSがこのようにひとかたまりのSQL文を扱うことをトランザクション制御(transaction control)といいます。

### SQLにおけるセミコロンの取り扱い
1つのSQL分の終了を表すためにセミコロンを用いる方法があることは触れました(p043)。「仮に単一のSQL文であっても、常にSQLの文末にはセミコロンを付ける」「末尾のセミコロンまで含めてSQLの文法」という理解をしても概ね差し支えありません。

但し、**現状では多くのDBMS製品がセミコロンを「SQLの構文規則」というよりは、文の区切りを判定するための「単なる記号」として扱っている点には注意が必要**です。たとえば、文の区切りをセミコロン以外の別の記号に設定できるDBMSは多数存在します。また、単一のSQL文であることが明らかな場合にセミコロンを付けると、エラーになってしまうこともあります(例：Oracle DBにおいてJavaから単一SQL文を直接送信する場合)。

この現状に鑑み、本書では、1つのリストで複数のSQL文を紹介する場合(リスト9-1など)にのみ、文末にセミコロンを記述しています。</details>


<details><summary>9.2 コミットとロールバック</summary>

### 9.2.1 トランザクションの中断
複数のSQL文を実行している最中に処理が中断してしまうと問題となるケースはたくさんあります。代表的なのが「金融機関における振り込み処理」です。

振り込み処理を実現するためには、「振込先口座の残高を減らす」「振込先口座の残高を増やす」という2つのUPDATE文の実行が必要です。しかし、最初のSQL文の実行が成功した直後にDBMSが異常停止して処理が中断してしまったら、「振込元口座からはお金が減らされたのに、振込先にはお金が増えない」事態となってしまいます。

この問題は、2つのUPDATE文を1つのトランザクションとして扱うようにDBMSに指示することで解決できます。なぜなら、DBMSはどんな非常時であっても、**トランザクションを「一部だけが実行されることはあってはならない、途中で分割不可能なもの」として取り扱う**からです。
- **DBMSによるトランザクション制御(1)**
    
    DBMSは、トランザクションに含まれるすべてのSQL文について、必ず「全ての実行が完了している」か「1つも実行されていない」のどちらかの状態になるように制御する。
トランザクションに含まれる複数のSQL文が、DBMSによって不可分なものとして扱われる性質のことをトランザクションの**原子性**(atomicity)といいます。

※原子性：「原子」のように、それ以上細かく分割できないことから。

### 9.2.2 原子性確保の仕組み
